<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reel to Deal â€” Movie Ticket Booking</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#080604;--sur:#100d09;--s2:#181410;--s3:#201a13;
  --or:#f07020;--orb:#ff8a35;--og:rgba(240,112,32,.12);--og2:rgba(240,112,32,.06);
  --tx:#f0e8d8;--mu:#7a6a5a;--bd:rgba(240,112,32,.18);
  --gr:#3fb876;--rd:#d94f4f;--yw:#e8b840;--bl:#4c82ff;
}
*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{background:var(--bg);color:var(--tx);font-family:'DM Sans',sans-serif;min-height:100vh;overflow-x:hidden;}

/* grain - static, no animation = no perf cost */
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:9000;opacity:.25;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='3'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");}

/* ambient orbs â€” CSS-only, no JS cost */
.amb{position:fixed;border-radius:50%;pointer-events:none;z-index:0;filter:blur(130px);opacity:.055;will-change:transform;}
.a1{width:500px;height:500px;background:var(--or);top:-150px;left:-150px;animation:orb1 18s ease-in-out infinite;}
.a2{width:380px;height:380px;background:#c84000;bottom:-100px;right:-100px;animation:orb2 22s ease-in-out infinite;}
@keyframes orb1{0%,100%{transform:translate(0,0)}50%{transform:translate(30px,-35px)}}
@keyframes orb2{0%,100%{transform:translate(0,0)}50%{transform:translate(-25px,25px)}}

/* â”€â”€ LOAD SCREEN â”€â”€ */
#ls{position:fixed;inset:0;z-index:9999;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;transition:opacity .5s,visibility .5s;}
#ls.out{opacity:0;visibility:hidden;pointer-events:none;}
.ls-logo{font-family:'Bebas Neue',sans-serif;font-size:clamp(1.8rem,6vw,2.8rem);letter-spacing:8px;color:var(--or);text-shadow:0 0 40px rgba(240,112,32,.5);animation:lsIn .9s cubic-bezier(.16,1,.3,1);}
@keyframes lsIn{from{opacity:0;letter-spacing:24px}to{opacity:1;letter-spacing:8px}}
.ls-bar{width:150px;height:2px;background:rgba(240,112,32,.15);border-radius:2px;overflow:hidden;}
.ls-fill{height:100%;background:linear-gradient(90deg,var(--or),var(--orb));animation:lsFill 1.1s ease .1s both;}
@keyframes lsFill{from{width:0}to{width:100%}}
.ls-sub{font-family:'Space Mono',monospace;font-size:.54rem;letter-spacing:4px;color:var(--mu);animation:fup .5s ease .5s both;}
@keyframes fup{from{opacity:0;transform:translateY(7px)}to{opacity:1;transform:translateY(0)}}
@keyframes fi{from{opacity:0}to{opacity:1}}
@keyframes spin{to{transform:rotate(360deg)}}

/* â”€â”€ SYNC BAR â”€â”€ */
.sync-bar{display:flex;align-items:center;justify-content:center;gap:7px;padding:7px 16px;font-family:'Space Mono',monospace;font-size:.56rem;letter-spacing:2px;color:var(--mu);border-bottom:1px solid rgba(240,112,32,.1);background:rgba(8,6,4,.6);position:relative;z-index:1;}
.sync-bar.live{color:var(--gr);border-bottom-color:rgba(63,184,118,.15);}
.sync-bar.err{color:var(--rd);}
.sdot{width:5px;height:5px;border-radius:50%;background:currentColor;flex-shrink:0;}
.sync-bar.live .sdot{animation:sdotP 2.5s ease-in-out infinite;}
.sync-bar.loading .sdot{animation:sdotP .5s ease-in-out infinite;}
@keyframes sdotP{0%,100%{opacity:.3}50%{opacity:1}}

/* â”€â”€ HEADER â”€â”€ */
header{padding:26px 20px 22px;text-align:center;border-bottom:1px solid var(--bd);background:linear-gradient(180deg,rgba(240,112,32,.06),transparent);position:relative;overflow:hidden;}
header::after{content:'';position:absolute;bottom:-1px;left:50%;transform:translateX(-50%);height:1px;width:200px;background:var(--or);box-shadow:0 0 16px var(--or);animation:glow 5s ease-in-out infinite;}
@keyframes glow{0%,100%{width:160px;opacity:.7}50%{width:320px;opacity:1}}
.logo{font-family:'Bebas Neue',sans-serif;font-size:clamp(2rem,7vw,3.2rem);letter-spacing:4px;color:var(--or);text-shadow:0 0 30px rgba(240,112,32,.4);line-height:1;animation:logoIn 1s cubic-bezier(.16,1,.3,1) .6s both;}
@keyframes logoIn{from{opacity:0;letter-spacing:16px}to{opacity:1;letter-spacing:4px}}
.logo span{color:var(--tx);}
.tagline{font-family:'Space Mono',monospace;font-size:.6rem;letter-spacing:3px;color:var(--mu);margin-top:4px;animation:fup .6s ease 1s both;}
.ev-badge{display:inline-flex;align-items:center;gap:8px;background:var(--og);border:1px solid var(--bd);border-radius:100px;padding:6px 16px;font-size:.66rem;color:var(--or);margin-top:12px;font-family:'Space Mono',monospace;letter-spacing:1px;animation:fup .6s ease 1.2s both;position:relative;overflow:hidden;}
.ev-badge::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(240,112,32,.18),transparent);transform:translateX(-100%);animation:shim 5s ease 2s infinite;}
@keyframes shim{0%{transform:translateX(-100%)}60%,100%{transform:translateX(100%)}}

/* â”€â”€ WRAP â”€â”€ */
.wrap{max-width:560px;margin:0 auto;padding:24px 16px 80px;position:relative;z-index:1;}

/* â”€â”€ NOTICE BANNER â”€â”€ */
.notice-banner{background:var(--og);border:1px solid var(--bd);border-radius:12px;padding:12px 16px;margin-bottom:18px;font-family:'Space Mono',monospace;font-size:.68rem;line-height:1.7;color:var(--or);display:none;animation:fup .35s ease both;}
.notice-banner.show{display:block;}

/* â”€â”€ COUNTDOWN â”€â”€ */
.cd-card{background:linear-gradient(135deg,rgba(240,112,32,.08),rgba(240,112,32,.03));border:1px solid var(--bd);border-radius:14px;padding:18px;margin-bottom:22px;text-align:center;position:relative;overflow:hidden;}
.cd-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--or),transparent);animation:scan 4s ease-in-out infinite;}
@keyframes scan{0%,100%{opacity:.35;transform:scaleX(.5)}50%{opacity:1;transform:scaleX(1)}}
.cd-label{font-family:'Space Mono',monospace;font-size:.58rem;letter-spacing:3px;color:var(--mu);text-transform:uppercase;margin-bottom:12px;}
.cd-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:7px;max-width:280px;margin:0 auto;}
.cd-unit{background:var(--s2);border:1px solid var(--bd);border-radius:9px;padding:10px 5px;}
.cd-n{font-family:'Bebas Neue',sans-serif;font-size:2rem;color:var(--or);line-height:1;display:block;text-shadow:0 0 15px rgba(240,112,32,.3);}
.cd-n.flip{animation:flip .22s ease;}
@keyframes flip{0%{transform:scaleY(1)}45%{transform:scaleY(.35);opacity:.2}100%{transform:scaleY(1)}}
.cd-t{font-family:'Space Mono',monospace;font-size:.48rem;letter-spacing:2px;color:var(--mu);text-transform:uppercase;margin-top:2px;display:block;}
.cd-live{font-family:'Bebas Neue',sans-serif;font-size:1.5rem;letter-spacing:3px;color:var(--rd);animation:livePulse 1.5s ease-in-out infinite;}
@keyframes livePulse{0%,100%{opacity:1}50%{opacity:.3}}

/* â”€â”€ STEPS â”€â”€ */
.steps{display:flex;align-items:center;justify-content:center;margin-bottom:30px;animation:fup .5s ease 1.4s both;}
.si{display:flex;flex-direction:column;align-items:center;gap:4px;}
.sn{width:32px;height:32px;border-radius:50%;border:1.5px solid var(--bd);display:flex;align-items:center;justify-content:center;font-family:'Space Mono',monospace;font-size:.68rem;color:var(--mu);background:var(--sur);transition:all .35s cubic-bezier(.34,1.56,.64,1);}
.si.active .sn{border-color:var(--or);color:var(--or);background:var(--og);box-shadow:0 0 14px rgba(240,112,32,.25);transform:scale(1.08);}
.si.done .sn{border-color:var(--gr);background:rgba(63,184,118,.1);color:var(--gr);}
.si.done .sn::after{content:'âœ“';}
.sl{font-size:.54rem;color:var(--mu);letter-spacing:1px;text-transform:uppercase;font-family:'Space Mono',monospace;white-space:nowrap;transition:color .3s;}
.si.active .sl{color:var(--or);}
.sc{width:44px;height:1px;background:var(--bd);margin:0 3px;margin-bottom:17px;flex-shrink:0;transition:background .4s,box-shadow .4s;}
.sc.done{background:var(--gr);box-shadow:0 0 6px rgba(63,184,118,.3);}

/* â”€â”€ SECTIONS â”€â”€ */
.sec{display:none;}
.sec.active{display:block;animation:secIn .4s cubic-bezier(.16,1,.3,1) both;}
@keyframes secIn{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€ CARD â”€â”€ */
.card{background:var(--sur);border:1px solid var(--bd);border-radius:14px;padding:22px;margin-bottom:12px;position:relative;overflow:hidden;transition:border-color .3s;}
.card:hover{border-color:rgba(240,112,32,.28);}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:1.5px;background:linear-gradient(90deg,transparent,rgba(240,112,32,.6),transparent);opacity:.5;}
.card-title{font-family:'Bebas Neue',sans-serif;font-size:1.25rem;letter-spacing:2px;color:var(--or);margin-bottom:16px;}

/* â”€â”€ TICKET SELECTOR â”€â”€ */
.t-display{background:var(--s2);border:1px solid var(--bd);border-radius:11px;padding:20px;margin-bottom:16px;text-align:center;}
.t-cnt{font-family:'Bebas Neue',sans-serif;font-size:5rem;color:var(--or);line-height:1;text-shadow:0 0 25px rgba(240,112,32,.3);display:block;}
.t-cnt.bump{animation:bump .28s cubic-bezier(.34,1.56,.64,1);}
@keyframes bump{0%{transform:scale(1)}50%{transform:scale(1.18)}100%{transform:scale(1)}}
.t-lbl{font-size:.68rem;letter-spacing:3px;color:var(--mu);text-transform:uppercase;font-family:'Space Mono',monospace;}
.qty-ctrl{display:flex;align-items:center;justify-content:center;gap:16px;margin-top:12px;}
.qbtn{width:44px;height:44px;border-radius:50%;border:1.5px solid var(--or);background:transparent;color:var(--or);font-size:1.4rem;cursor:pointer;transition:all .22s cubic-bezier(.34,1.56,.64,1);display:flex;align-items:center;justify-content:center;line-height:1;}
.qbtn:hover{background:var(--or);color:#fff;box-shadow:0 0 18px rgba(240,112,32,.35);transform:scale(1.1);}
.qbtn:disabled{opacity:.3;cursor:not-allowed;transform:none;box-shadow:none;}
.price-bd{background:var(--s2);border-radius:10px;padding:13px;}
.pr{display:flex;justify-content:space-between;padding:5px 0;font-size:.85rem;color:var(--mu);}
.pr.tot{border-top:1px solid var(--bd);margin-top:8px;padding-top:11px;color:var(--tx);font-size:1rem;font-weight:600;}
.pr.tot span:last-child{color:var(--or);font-family:'Bebas Neue',sans-serif;font-size:1.65rem;letter-spacing:1px;}
.pPop{animation:pPop .28s cubic-bezier(.34,1.56,.64,1);}
@keyframes pPop{0%,100%{transform:scale(1)}50%{transform:scale(1.12)}}

/* â”€â”€ FORM â”€â”€ */
.fg{margin-bottom:16px;}
label{display:block;font-size:.62rem;letter-spacing:2px;text-transform:uppercase;color:var(--mu);margin-bottom:6px;font-family:'Space Mono',monospace;}
input[type=text],input[type=email],input[type=tel]{width:100%;background:var(--s2);border:1px solid var(--bd);border-radius:9px;padding:12px 14px;color:var(--tx);font-family:'DM Sans',sans-serif;font-size:.92rem;outline:none;transition:border-color .2s,box-shadow .2s;}
input:focus{border-color:var(--or);box-shadow:0 0 0 3px var(--og);}
input.err{border-color:var(--rd);animation:shake .3s ease;}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
input.ok{border-color:var(--gr);}
.ferr{color:var(--rd);font-size:.67rem;margin-top:4px;display:none;font-family:'Space Mono',monospace;letter-spacing:.5px;}
.ferr.show{display:block;animation:fup .2s ease;}

/* â”€â”€ UPI BOX â”€â”€ */
.upi-box{background:linear-gradient(135deg,var(--s2),var(--s3));border:1px solid var(--or);border-radius:13px;padding:20px;margin-bottom:14px;}
.amt-big{font-family:'Bebas Neue',sans-serif;font-size:3.6rem;color:var(--or);text-shadow:0 0 30px rgba(240,112,32,.4);line-height:1;text-align:center;display:block;}
.amt-lbl{font-size:.62rem;letter-spacing:3px;color:var(--mu);text-transform:uppercase;font-family:'Space Mono',monospace;text-align:center;display:block;}
.upi-row{display:flex;align-items:center;justify-content:space-between;background:var(--sur);border:1px solid var(--bd);border-radius:9px;padding:11px 13px;margin-bottom:8px;}
.upi-lbl{font-size:.6rem;color:var(--mu);letter-spacing:1px;text-transform:uppercase;font-family:'Space Mono',monospace;display:block;margin-bottom:2px;}
.upi-val{font-family:'Space Mono',monospace;font-size:.88rem;color:var(--tx);font-weight:700;}
.copy-btn{background:var(--og);border:1px solid var(--or);color:var(--or);padding:6px 12px;border-radius:7px;font-size:.65rem;cursor:pointer;font-family:'Space Mono',monospace;letter-spacing:1px;transition:all .2s;white-space:nowrap;}
.copy-btn:hover{background:rgba(240,112,32,.2);}
.copy-btn.copied{border-color:var(--gr);color:var(--gr);}

/* â”€â”€ TIMER â”€â”€ */
.tmr-box{display:flex;align-items:center;justify-content:center;gap:12px;background:var(--s2);border:1px solid var(--bd);border-radius:10px;padding:12px;margin-bottom:16px;position:relative;overflow:hidden;}
.tmr-prog{position:absolute;bottom:0;left:0;height:2px;background:linear-gradient(90deg,var(--gr),var(--yw),var(--rd));transform-origin:left;animation:tProg 600s linear forwards;}
@keyframes tProg{from{transform:scaleX(1)}to{transform:scaleX(0)}}
.tmr-num{font-family:'Space Mono',monospace;font-size:1.35rem;font-weight:700;color:var(--or);letter-spacing:2px;transition:color .3s;}
.tmr-num.warn{color:var(--rd);animation:tPulse 1s ease-in-out infinite;}
@keyframes tPulse{0%,100%{opacity:1}50%{opacity:.5}}

/* â”€â”€ UPI APPS â”€â”€ */
.upi-apps{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;margin-bottom:14px;}
.app-btn{background:var(--s2);border:1px solid var(--bd);border-radius:11px;padding:11px 7px;text-align:center;cursor:pointer;transition:all .22s;display:block;}
.app-btn:hover{border-color:var(--or);background:var(--og);transform:translateY(-2px);}
.app-icon{font-size:1.6rem;display:block;margin-bottom:3px;}
.app-name{font-size:.58rem;letter-spacing:1px;color:var(--mu);font-family:'Space Mono',monospace;}

/* â”€â”€ UPLOAD â”€â”€ */
.up-zone{border:2px dashed var(--bd);border-radius:13px;padding:26px;text-align:center;cursor:pointer;transition:all .22s;position:relative;}
.up-zone:hover,.up-zone.drag{border-color:var(--or);border-style:solid;background:rgba(240,112,32,.03);}
.up-zone input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.up-icon{font-size:2rem;margin-bottom:7px;display:block;}
.up-text{color:var(--mu);font-size:.8rem;}
.up-text strong{color:var(--or);}
.up-prev{width:100%;max-height:170px;object-fit:cover;border-radius:9px;margin-top:12px;display:none;border:1px solid var(--bd);}
.up-prev.show{display:block;animation:fi .25s ease;}
.ocr-box{background:var(--s2);border-radius:9px;padding:11px 13px;margin-top:9px;font-size:.75rem;font-family:'Space Mono',monospace;display:none;}
.ocr-box.show{display:block;animation:fi .3s ease;}
.ocr-item{display:flex;align-items:center;gap:7px;padding:3px 0;color:var(--mu);}
.ocr-item.pass{color:var(--gr);}
.ocr-item.fail{color:var(--rd);}
.ocr-spin{display:inline-block;width:12px;height:12px;border:2px solid rgba(240,112,32,.2);border-top-color:var(--or);border-radius:50%;animation:spin .7s linear infinite;flex-shrink:0;}

/* â”€â”€ STATUS MSG â”€â”€ */
.smsg{border-radius:9px;padding:11px 14px;margin-bottom:12px;font-size:.78rem;font-family:'Space Mono',monospace;display:none;line-height:1.6;}
.smsg.show{display:block;animation:fup .25s ease;}
.smsg.error{background:rgba(217,79,79,.08);border:1px solid rgba(217,79,79,.28);color:var(--rd);}
.smsg.success{background:rgba(63,184,118,.08);border:1px solid rgba(63,184,118,.28);color:var(--gr);}
.smsg.info{background:var(--og);border:1px solid var(--bd);color:var(--or);}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{width:100%;padding:14px 22px;border-radius:11px;font-size:.82rem;font-weight:600;letter-spacing:2px;text-transform:uppercase;font-family:'Space Mono',monospace;cursor:pointer;transition:all .22s;border:none;position:relative;overflow:hidden;}
.btn::after{content:'';position:absolute;top:50%;left:-100%;width:50%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.08),transparent);transform:translateY(-50%);transition:left .4s;}
.btn:hover::after{left:150%;}
.btn-p{background:linear-gradient(135deg,var(--or),#c84800);color:#fff;}
.btn-p:hover{transform:translateY(-2px);box-shadow:0 10px 28px rgba(240,112,32,.35);}
.btn-p:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none;}
.btn-s{background:transparent;border:1px solid var(--bd);color:var(--mu);margin-top:8px;}
.btn-s:hover{border-color:var(--or);color:var(--or);}
.btn-g{background:rgba(63,184,118,.12);border:1px solid var(--gr);color:var(--gr);}
.btn-g:hover{background:rgba(63,184,118,.22);transform:translateY(-2px);}
.btn-wa{background:rgba(37,211,102,.1);border:1px solid #25d366;color:#25d366;}
.btn-wa:hover{background:rgba(37,211,102,.2);}
.spn{width:14px;height:14px;border:2px solid rgba(255,255,255,.25);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;display:inline-block;vertical-align:middle;margin-right:6px;}

/* â”€â”€ TICKET CARD â”€â”€ */
.tkt-card{background:var(--sur);border:1px solid var(--or);border-radius:14px;overflow:hidden;position:relative;box-shadow:0 0 40px rgba(240,112,32,.1);animation:tktIn .7s cubic-bezier(.16,1,.3,1) both;}
.tkt-card.glow-green{border-color:var(--gr);box-shadow:0 0 50px rgba(63,184,118,.18);}
@keyframes tktIn{from{opacity:0;transform:scale(.9) translateY(14px)}to{opacity:1;transform:scale(1) translateY(0)}}
.tkt-hdr{background:linear-gradient(135deg,rgba(240,112,32,.15),rgba(240,112,32,.04));padding:20px;text-align:center;border-bottom:1px dashed var(--bd);}
.tkt-title{font-family:'Bebas Neue',sans-serif;font-size:1.8rem;letter-spacing:4px;color:var(--or);}
.tkt-body{padding:18px;}
.tkt-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.04);font-size:.83rem;animation:rowIn .35s ease both;}
@keyframes rowIn{from{opacity:0;transform:translateX(-6px)}to{opacity:1;transform:translateX(0)}}
.tkt-row:last-child{border:none;}
.tkt-k{color:var(--mu);font-family:'Space Mono',monospace;font-size:.62rem;letter-spacing:1px;text-transform:uppercase;}
.tkt-v{font-weight:600;}
.tkt-qr{display:flex;justify-content:center;padding:16px;border-top:1px dashed var(--bd);}
.sbadge{display:inline-block;padding:3px 11px;border-radius:100px;font-size:.62rem;font-family:'Space Mono',monospace;letter-spacing:2px;text-transform:uppercase;font-weight:700;border:1px solid;}
.sbadge.pending{background:rgba(232,184,64,.1);color:var(--yw);border-color:rgba(232,184,64,.3);}
.sbadge.approved{background:rgba(63,184,118,.1);color:var(--gr);border-color:rgba(63,184,118,.3);animation:gBadge 2.5s ease-in-out infinite;}
@keyframes gBadge{0%,100%{box-shadow:0 0 0 0 rgba(63,184,118,.15)}50%{box-shadow:0 0 10px 2px rgba(63,184,118,.22)}}

/* film strip */
.fstrip{display:flex;gap:4px;padding:6px 10px;overflow:hidden;opacity:.15;pointer-events:none;}
.fhole{width:13px;height:10px;border-radius:2px;background:var(--or);flex-shrink:0;}

/* â”€â”€ DL GRID â”€â”€ */
.dl-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:7px;margin-top:12px;}
.dl-grid>*{font-size:.64rem!important;padding:11px 5px!important;margin:0!important;width:100%;}
.dl-full{grid-column:1/-1;display:grid;grid-template-columns:1fr 1fr;gap:7px;}

/* â”€â”€ MODALS â”€â”€ */
#softModal,#emailModal{position:fixed;inset:0;z-index:5000;display:none;align-items:center;justify-content:center;}
#softModal.show,#emailModal.show{display:flex;background:rgba(0,0,0,.88);backdrop-filter:blur(14px);animation:fi .25s ease;}
.modal-inner{background:var(--sur);border:1px solid rgba(240,112,32,.22);border-radius:16px;padding:20px;max-width:350px;width:92%;position:relative;animation:mdlIn .4s cubic-bezier(.34,1.56,.64,1);}
@keyframes mdlIn{from{opacity:0;transform:scale(.86)}to{opacity:1;transform:scale(1)}}
.modal-close{position:absolute;top:11px;right:11px;background:rgba(255,255,255,.06);border:none;color:var(--mu);width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:.95rem;display:flex;align-items:center;justify-content:center;transition:all .2s;}
.modal-close:hover{background:rgba(217,79,79,.15);color:var(--rd);transform:rotate(90deg);}
.modal-title{font-family:'Bebas Neue',sans-serif;font-size:1.25rem;letter-spacing:2px;color:var(--or);text-align:center;margin-bottom:13px;}
#tktCanvas{width:100%;border-radius:9px;border:1px solid rgba(240,112,32,.15);display:block;margin-bottom:12px;}
.email-prev{background:var(--s2);border:1px solid var(--bd);border-radius:9px;padding:12px;font-family:'Space Mono',monospace;font-size:.67rem;line-height:1.75;color:var(--tx);max-height:200px;overflow-y:auto;margin-bottom:12px;white-space:pre-wrap;}
.email-modal-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;}

/* â”€â”€ TOAST â”€â”€ */
.toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--s2);border:1px solid var(--bd);border-radius:9px;padding:9px 16px;font-family:'Space Mono',monospace;font-size:.72rem;color:var(--tx);z-index:9999;transition:transform .32s cubic-bezier(.34,1.56,.64,1);white-space:nowrap;max-width:90vw;backdrop-filter:blur(12px);}
.toast.show{transform:translateX(-50%) translateY(0);}
.toast.success{border-color:var(--gr);color:var(--gr);}
.toast.error{border-color:var(--rd);color:var(--rd);}
.toast.info{border-color:var(--or);color:var(--or);}

/* â”€â”€ CONFETTI â”€â”€ */
.cf{position:fixed;pointer-events:none;z-index:9990;border-radius:2px;animation:cfFall var(--dur,1.2s) ease-out var(--dl,0s) both;}
@keyframes cfFall{from{transform:translate(0,-10px) rotate(0deg);opacity:1}to{transform:translate(var(--drift,0px),100vh) rotate(720deg);opacity:0}}

.adm-lnk{text-align:center;margin-top:32px;padding-top:16px;border-top:1px solid var(--bd);}
.adm-lnk a{font-family:'Space Mono',monospace;font-size:.62rem;color:var(--mu);text-decoration:none;letter-spacing:2px;transition:color .2s;}
.adm-lnk a:hover{color:var(--or);}

@media(max-width:460px){
  .upi-apps{grid-template-columns:repeat(2,1fr);}
  .sc{width:26px;}
  .card{padding:16px 13px;}
  .dl-grid{grid-template-columns:1fr 1fr;}
  .dl-grid>*:nth-child(3){grid-column:1/-1;}
}

.pss-item{display:flex;align-items:center;gap:4px;font-family:'Space Mono',monospace;font-size:.58rem;color:var(--muted);}
.pss-item.active{color:var(--orange);}
.pss-item.done{color:var(--green);}
.pss-dot{width:20px;height:20px;border-radius:50%;border:1.5px solid currentColor;display:flex;align-items:center;justify-content:center;font-size:.62rem;flex-shrink:0;transition:all .3s;}
.pss-item.active .pss-dot{background:var(--og);animation:psAnim 1.8s ease-in-out infinite;}
@keyframes psAnim{0%,100%{box-shadow:0 0 0 0 rgba(240,112,32,.25)}50%{box-shadow:0 0 0 4px rgba(240,112,32,0)}}
.pss-line{flex:1;height:1px;background:var(--border);min-width:12px;}
.pss-line.done{background:var(--green);}

</style>
</head>
<body>

<div class="amb a1"></div>
<div class="amb a2"></div>

<!-- LOAD SCREEN -->
<div id="ls">
  <div class="ls-logo">ğŸ¬ Reel &amp; Deal</div>
  <div class="ls-bar"><div class="ls-fill"></div></div>
  <div class="ls-sub">LOADING YOUR EXPERIENCE...</div>
</div>

<!-- SYNC BAR -->
<div class="sync-bar loading" id="syncBar">
  <div class="sdot"></div><span id="syncTxt">Connecting to server...</span>
</div>

<header>
  <div class="logo">Reel <span>&amp;</span> Deal</div>
  <div class="tagline">The MBA Pitch Arena Â· From Plotlines to Profits</div>
  <div class="ev-badge" id="evBadge">ğŸ¬ MBA FESTIVAL</div>
</header>

<div class="wrap">

  <!-- NOTICE BANNER (event description) -->
  <div class="notice-banner" id="noticeBanner"></div>

  <!-- COUNTDOWN -->
  <div class="cd-card" id="cdCard">
    <div class="cd-label">ğŸ¬ Event starts in</div>
    <div class="cd-grid">
      <div class="cd-unit"><span class="cd-n" id="cdD">00</span><span class="cd-t">Days</span></div>
      <div class="cd-unit"><span class="cd-n" id="cdH">00</span><span class="cd-t">Hrs</span></div>
      <div class="cd-unit"><span class="cd-n" id="cdM">00</span><span class="cd-t">Mins</span></div>
      <div class="cd-unit"><span class="cd-n" id="cdS">00</span><span class="cd-t">Secs</span></div>
    </div>
  </div>

  <!-- STEPS -->
  <div class="steps">
    <div class="si active" id="s1"><div class="sn">1</div><div class="sl">Tickets</div></div>
    <div class="sc" id="sc1"></div>
    <div class="si" id="s2"><div class="sn">2</div><div class="sl">Details</div></div>
    <div class="sc" id="sc2"></div>
    <div class="si" id="s3"><div class="sn">3</div><div class="sl">Payment</div></div>
    <div class="sc" id="sc3"></div>
    <div class="si" id="s4"><div class="sn">4</div><div class="sl">Ticket</div></div>
  </div>

  <!-- STEP 1 -->
  <div class="sec active" id="sec1">
    <div class="fstrip" id="fs1"></div>
    <div class="card">
      <div class="card-title">ğŸŸ Select Tickets</div>
      <div class="t-display">
        <span class="t-cnt" id="tCnt">1</span>
        <div class="t-lbl">Ticket(s) Selected</div>
        <div class="qty-ctrl">
          <button class="qbtn" id="btnM" onclick="chgQty(-1)">âˆ’</button>
          <button class="qbtn" id="btnP" onclick="chgQty(1)">+</button>
        </div>
      </div>
      <div class="price-bd">
        <div class="pr"><span>Price per ticket</span><span id="ppt">â‚¹100</span></div>
        <div class="pr"><span>Quantity</span><span id="qD">1</span></div>
        <div class="pr tot"><span>Total Amount</span><span id="totD">â‚¹100</span></div>
      </div>
    </div>
    <button class="btn btn-p" onclick="goStep(2)">Continue â†’</button>

    <!-- BOOKING LOOKUP -->
    <div style="background:rgba(240,112,32,.04);border:1px solid var(--border);border-radius:var(--r12);padding:15px;margin-top:10px;">
      <div style="font-family:'Space Mono',monospace;font-size:.62rem;letter-spacing:2px;color:var(--muted);text-transform:uppercase;margin-bottom:10px;">ğŸ” Check Existing Booking</div>
      <div style="display:flex;gap:7px;">
        <input type="text" id="lookupInput" placeholder="Enter Booking ID or UTR..." style="flex:1;border-radius:8px;background:var(--s2);border:1px solid var(--border);padding:10px 12px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:.88rem;outline:none;">
        <button onclick="lookupBooking()" style="padding:10px 14px;background:rgba(68,196,136,.12);border:1px solid var(--green);color:var(--green);border-radius:8px;font-family:'Space Mono',monospace;font-size:.65rem;letter-spacing:1px;cursor:pointer;white-space:nowrap;transition:all .2s;">Check</button>
      </div>
      <div id="lookupResult" style="display:none;margin-top:9px;background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:11px 13px;font-family:'Space Mono',monospace;font-size:.72rem;line-height:1.8;"></div>
    </div>
  </div>

  <!-- STEP 2 -->
  <div class="sec" id="sec2">
    <div class="card">
      <div class="card-title">ğŸ‘¤ Your Details</div>
      <div class="fg">
        <label>Full Name</label>
        <input type="text" id="fname" placeholder="Enter your full name" oninput="valF('fname')">
        <div class="ferr" id="fnameE">Please enter your full name (min 2 chars)</div>
      </div>
      <div class="fg">
        <label>Email Address</label>
        <input type="email" id="femail" placeholder="you@college.edu" oninput="valF('femail')">
        <div class="ferr" id="femailE">Please enter a valid email address</div>
      </div>
      <div class="fg">
        <label>Phone Number</label>
        <input type="tel" id="fphone" placeholder="10-digit mobile number" maxlength="10" oninput="valF('fphone')">
        <div class="ferr" id="fphoneE">Please enter a valid 10-digit number</div>
      </div>
    </div>
    <button class="btn btn-p" onclick="validateDetails()">Proceed to Payment â†’</button>
    <button class="btn btn-s" onclick="goStep(1)">â† Back</button>
  </div>

  <!-- STEP 3 -->
  <div class="sec" id="sec3">
        <!-- PAY SUB-STEPS -->
    <div style="display:flex;align-items:center;gap:6px;margin-bottom:13px;padding:2px 0;">
      <div class="pss-item active" id="pss1"><div class="pss-dot">1</div></div>
      <div class="pss-line" id="psl1"></div>
      <div class="pss-item" id="pss2"><div class="pss-dot">2</div><span>Pay</span></div>
      <div class="pss-line" id="psl2"></div>
      <div class="pss-item" id="pss3"><div class="pss-dot">3</div><span>Screenshot</span></div>
      <div class="pss-line" id="psl3"></div>
      <div class="pss-item" id="pss4"><div class="pss-dot">4</div><span>Submit</span></div>
    </div>
    <div class="tmr-box">
      <span style="font-size:1.3rem">â±</span>
      <div>
        <div style="font-size:.58rem;color:var(--mu);letter-spacing:2px;font-family:'Space Mono',monospace;">COMPLETE PAYMENT IN</div>
        <div class="tmr-num" id="tmrD">10:00</div>
      </div>
      <div class="tmr-prog"></div>
    </div>
    <div class="upi-box">
      <div style="margin-bottom:16px;text-align:center;">
        <span class="amt-lbl">Total Payable</span>
        <span class="amt-big" id="payAmt">â‚¹100</span>
        <span class="amt-lbl" id="payInfo">for 1 ticket</span>
      </div>
      <div class="upi-row">
        <div><span class="upi-lbl">UPI ID</span><span class="upi-val" id="upiD"></span></div>
        <button class="copy-btn" onclick="copyUPI(this)">COPY</button>
      </div>
      <div class="upi-row">
        <div><span class="upi-lbl">Payee Name</span><span class="upi-val" id="payeeD"></span></div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">ğŸ“± Pay With App</div>
      <div class="upi-apps" id="upiApps"></div>
      <p style="font-size:.62rem;color:var(--mu);text-align:center;font-family:'Space Mono',monospace;letter-spacing:1px;">TAP APP â†’ VERIFY AMOUNT â†’ PAY â†’ COME BACK</p>
    </div>
    <div class="card">
      <div class="card-title">âœ… Verify Payment</div>
      <div class="smsg" id="statusMsg"></div>
      <div class="fg">
        <label>UTR / Transaction ID</label>
        <input type="text" id="utrI" placeholder="12-digit UTR or Paytm TxnID (starts with T)" oninput="valUTR()">
        <div class="ferr" id="utrE">Invalid format â€” enter 12+ digit UTR or Paytm ID starting with T</div>
      </div>
      <div class="fg">
        <label>Payment Screenshot</label>
        <div class="up-zone" id="upZone">
          <input type="file" id="ssFile" accept=".jpg,.jpeg,.png,.webp,.heic" onchange="handleFile(event)">
          <span class="up-icon">ğŸ“¸</span>
          <p class="up-text">Drop screenshot here or <strong>browse</strong></p>
          <p style="font-size:.62rem;color:var(--mu);margin-top:4px;font-family:'Space Mono',monospace;">JPG Â· PNG Â· WEBP Â· HEIC Â· MAX 5MB</p>
        </div>
        <img class="up-prev" id="ssPrev" alt="">
        <div class="ocr-box" id="ocrBox">
          <div class="ocr-item" id="ocrP" style="color:var(--or)"><div class="ocr-spin"></div> Analyzing screenshot...</div>
          <div class="ocr-item" id="ocrA" style="display:none"></div>
          <div class="ocr-item" id="ocrU" style="display:none"></div>
        </div>
        <div class="ferr" id="ssE">Please upload your payment screenshot</div>
      </div>
    </div>
    <button class="btn btn-p" id="subBtn" onclick="submitBooking()">Submit Booking</button>
    <button class="btn btn-s" onclick="cancelPay()">Cancel &amp; Go Back</button>
  </div>

  <!-- STEP 4 -->
  <div class="sec" id="sec4">
    <div class="smsg show" id="successMsg" style="display:block;margin-bottom:16px;"></div>
    <div class="tkt-card" id="tktCard">
      <div class="fstrip" id="fs2" style="padding:5px 10px;opacity:.18;"></div>
      <div class="tkt-hdr">
        <div style="font-size:.6rem;letter-spacing:3px;color:var(--mu);font-family:'Space Mono',monospace;margin-bottom:4px;" id="tktLabel">REEL TO DEAL Â· MBA 2025</div>
        <div class="tkt-title" id="tktTitle">ğŸ¬ Movie Ticket</div>
        <div style="font-size:.66rem;color:var(--mu);margin-top:4px;font-family:'Space Mono',monospace;" id="tktDate">FEB 17, 2025 Â· 1:00 PM</div>
      </div>
      <div class="tkt-body" id="tktBody"></div>
      <div class="tkt-qr"><div id="qrDiv"></div></div>
      <div class="fstrip" id="fs3" style="padding:5px 10px;opacity:.18;"></div>
    </div>
    <div class="dl-grid">
      <button class="btn btn-p" onclick="dlPDF()">ğŸ“„ PDF</button>
      <button class="btn btn-g" onclick="showSoftCopy()">ğŸ–¼ Image</button>
      <button class="btn btn-g" style="background:rgba(76,130,255,.1);border-color:var(--bl);color:var(--bl);" onclick="showEmailModal()">âœ‰ Email</button>
      <div class="dl-full">
        <button class="btn btn-wa" onclick="shareWA()">ğŸ’¬ WhatsApp</button>
        <button class="btn btn-s" onclick="printTkt()" style="margin:0;">ğŸ–¨ Print</button>
      </div>
    </div>
    <div class="card" style="margin-top:12px;">
      <p style="font-size:.72rem;color:var(--mu);line-height:1.8;font-family:'Space Mono',monospace;">
        ğŸ“Œ <strong style="color:var(--or)">PENDING?</strong> Payment is being verified. You'll be notified once approved.<br><br>
        âœ… <strong style="color:var(--gr)">APPROVED?</strong> You're all set â€” show this ticket at the gate.
      </p>
    </div>
  </div>

      <button class="btn btn-s" onclick="bookAnother()" style="margin-top:6px;">+ Book Another Ticket</button>

  <div class="adm-lnk"><a href="admin.html">Admin Panel â†’</a></div>
</div>

<!-- SOFT COPY MODAL -->
<div id="softModal">
  <div class="modal-inner">
    <button class="modal-close" onclick="closeSoftCopy()">âœ•</button>
    <div class="modal-title">ğŸŸ Digital Ticket</div>
    <canvas id="tktCanvas"></canvas>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:7px;">
      <button class="btn btn-g" onclick="dlImage()" style="font-size:.68rem;padding:10px;margin:0;">â¬‡ Save</button>
      <button class="btn btn-s" onclick="closeSoftCopy()" style="font-size:.68rem;padding:10px;margin:0;">Close</button>
    </div>
  </div>
</div>

<!-- EMAIL MODAL -->
<div id="emailModal">
  <div class="modal-inner email-modal" style="border-color:rgba(63,184,118,.2);">
    <button class="modal-close" onclick="closeEmailModal()">âœ•</button>
    <div class="modal-title" style="color:var(--gr);">âœ‰ Email Ticket</div>
    <div class="email-prev" id="emailPrev"></div>
    <div class="email-modal-grid">
      <button class="btn btn-g" onclick="sendEmail()" style="font-size:.68rem;padding:10px;margin:0;">Open Email App</button>
      <button class="btn btn-s" onclick="closeEmailModal()" style="font-size:.68rem;padding:10px;margin:0;">Cancel</button>
    </div>
    <p style="font-size:.58rem;color:var(--mu);margin-top:7px;font-family:'Space Mono',monospace;text-align:center;letter-spacing:1px;">Opens your default mail client pre-filled.</p>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUPABASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SB_URL = 'https://yhrfpcwehtqsppoifhog.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlocmZwY3dlaHRxc3Bwb2lmaG9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1NzQ5MDAsImV4cCI6MjA4NzE1MDkwMH0.Ml1V2zc8j3XCZIuILuapy2Cs4jcBl0i6sHKxFFl6Sqo';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG (loaded from Supabase, falls back to defaults)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEFAULTS = {
  movieName:'Reel to Deal', venue:'MBA Auditorium',
  eventDate:'2025-02-17T13:00', eventDateDisplay:'FEB 17, 2025 Â· 1:00 PM',
  ticketPrice:100, maxTickets:10,
  upiId:'hiteshhayagriv@okicici', payeeName:'REEL TO DEAL',
  autoApprove:true, eventDescription:''
};
let CFG = { ...DEFAULTS };

let qty = 1, step = 1, tmrInt = null, tmrSecs = 600;
let bData = {}, ssFile = null, ocrAmt = false, ocrUpi = false, rateTs = [];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('load', async () => {
  buildFilmStrips();
  setSyncState('loading', 'Connecting to server...');

  // Load config from Supabase
  await loadConfig();
  applyConfig();
  startCd();
  buildApps();
  chgQty(0);
  initDrag();

  setTimeout(() => {
    const ls = document.getElementById('ls');
    ls.classList.add('out');
    setTimeout(() => ls.style.display = 'none', 500);
  }, 1100);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SYNC BAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setSyncState(state, msg) {
  const b = document.getElementById('syncBar');
  const t = document.getElementById('syncTxt');
  b.className = 'sync-bar ' + (state === 'live' ? 'live' : state === 'err' ? 'err' : 'loading');
  t.textContent = msg;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOAD CONFIG FROM SUPABASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadConfig() {
  setSyncState('syncing', 'Fetching live event settings...');
  try {
    const res = await fetch(
      `${SB_URL}/rest/v1/app_settings?id=eq.1&select=*`,
      { headers: { 'apikey': SB_KEY, 'Authorization': `Bearer ${SB_KEY}` } }
    );
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    if (data && data.length > 0) {
      const s = data[0];
      Object.assign(CONFIG, {
        movieName: s.movie_name || DEFAULTS.movieName,
        venue: s.venue || DEFAULTS.venue,
        eventDate: s.event_date || DEFAULTS.eventDate,
        eventDateDisplay: s.event_date_display || DEFAULTS.eventDateDisplay,
        ticketPrice: s.ticket_price || DEFAULTS.ticketPrice,
        maxTickets: s.max_tickets || DEFAULTS.maxTickets,
        upiId: s.upi_id || DEFAULTS.upiId,
        payeeName: s.payee_name || DEFAULTS.payeeName,
        autoApprove: s.auto_approve != null ? s.auto_approve : DEFAULTS.autoApprove,
      });
    }
    setSyncState('ok', 'Live Â· Settings synced âœ“');
    setTimeout(() => { const sb = document.getElementById('syncBar'); if(sb) sb.style.opacity = '.5'; }, 5000);
  } catch (e) {
    console.warn('Config load failed, using defaults', e);
    setSyncState('error', 'Offline Â· Using default settings');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// APPLY CONFIG TO UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applyConfig() {
  document.getElementById('evBadge').textContent = 'ğŸ¬ ' + CFG.movieName.toUpperCase();
  document.getElementById('tktTitle').textContent = 'ğŸ¬ ' + CFG.movieName;
  document.getElementById('tktDate').textContent = CFG.eventDateDisplay;
  document.getElementById('tktLabel').textContent = CFG.movieName.toUpperCase() + ' Â· MBA 2025';
  document.getElementById('upiD').textContent = CFG.upiId;
  document.getElementById('payeeD').textContent = CFG.payeeName;
  document.getElementById('ppt').textContent = 'â‚¹' + CFG.ticketPrice;
  updatePrice();
  // Show event description if set
  if (CFG.eventDescription) {
    const nb = document.getElementById('noticeBanner');
    nb.textContent = 'ğŸ“¢ ' + CFG.eventDescription;
    nb.classList.add('show');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COUNTDOWN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startCd() {
  const target = new Date(CFG.eventDate).getTime();
  function tick() {
    const diff = target - Date.now();
    if (diff <= 0) {
      document.getElementById('cdCard').innerHTML = '<div class="cd-live">ğŸ¬ EVENT IS LIVE NOW!</div>';
      return;
    }
    const d = Math.floor(diff / 86400000);
    const h = Math.floor((diff % 86400000) / 3600000);
    const m = Math.floor((diff % 3600000) / 60000);
    const s = Math.floor((diff % 60000) / 1000);
    [['cdD',d],['cdH',h],['cdM',m],['cdS',s]].forEach(([id,v]) => {
      const el = document.getElementById(id);
      const vs = String(v).padStart(2, '0');
      if (el && el.textContent !== vs) {
        el.classList.remove('flip'); void el.offsetWidth; el.classList.add('flip');
        el.textContent = vs;
      }
    });
    setTimeout(tick, 1000);
  }
  tick();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILM STRIPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildFilmStrips() {
  ['fs1','fs2','fs3'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.innerHTML = Array(40).fill('<div class="fhole"></div>').join('');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUPABASE HELPERS (fixed â€” no updated_at in PATCH, correct Prefer headers)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sbPost(table, body) {
  const res = await fetch(`${SB_URL}/rest/v1/${table}`, {
    method: 'POST',
    headers: {
      'apikey': SB_KEY, 'Authorization': `Bearer ${SB_KEY}`,
      'Content-Type': 'application/json', 'Prefer': 'return=representation'
    },
    body: JSON.stringify(body)
  });
  if (!res.ok) {
    const e = await res.json().catch(() => ({}));
    throw new Error(e.message || e.hint || 'HTTP ' + res.status);
  }
  return res.json();
}

async function sbGet(ep) {
  const res = await fetch(`${SB_URL}/rest/v1/${ep}`, {
    headers: { 'apikey': SB_KEY, 'Authorization': `Bearer ${SB_KEY}` }
  });
  if (!res.ok) throw new Error('HTTP ' + res.status);
  return res.json();
}

async function sbUpload(bucket, path, file) {
  const res = await fetch(`${SB_URL}/storage/v1/object/${bucket}/${path}`, {
    method: 'POST',
    headers: {
      'apikey': SB_KEY, 'Authorization': `Bearer ${SB_KEY}`,
      'Content-Type': file.type, 'x-upsert': 'true'
    },
    body: file
  });
  if (!res.ok) throw new Error('Upload failed ' + res.status);
  return `${SB_URL}/storage/v1/object/public/${bucket}/${path}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QTY + PRICE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function chgQty(d) {
  qty = Math.max(1, Math.min(CFG.maxTickets, qty + d));
  const el = document.getElementById('tCnt');
  el.textContent = qty;
  el.classList.remove('bump'); void el.offsetWidth; el.classList.add('bump');
  updatePrice();
  document.getElementById('btnM').disabled = qty <= 1;
  document.getElementById('btnP').disabled = qty >= CFG.maxTickets;
}

function updatePrice() {
  document.getElementById('qD').textContent = qty;
  const tot = document.getElementById('totD');
  tot.textContent = 'â‚¹' + (qty * CFG.ticketPrice);
  tot.classList.remove('pPop'); void tot.offsetWidth; tot.classList.add('pPop');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STEPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goStep(s) {
  document.querySelectorAll('.sec').forEach((el, i) => el.classList.toggle('active', i + 1 === s));
  for (let i = 1; i <= 4; i++) {
    const el = document.getElementById('s' + i);
    el.classList.remove('active','done');
    if (i < s) el.classList.add('done');
    if (i === s) el.classList.add('active');
  }
  for (let i = 1; i <= 3; i++) document.getElementById('sc' + i).classList.toggle('done', i < s);
  step = s;
  window.scrollTo({ top: 0, behavior: 'smooth' });
  if (s === 4) { launchConfetti(); setTimeout(() => drawCanvas(bData), 600); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFETTI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function launchConfetti() {
  const clrs = ['#f07020','#ff8a35','#3fb876','#e8b840','#d94f4f','#4c82ff'];
  for (let i = 0; i < 55; i++) {
    const p = document.createElement('div');
    p.className = 'cf';
    const drift = (Math.random() - .5) * 180;
    const size = 4 + Math.random() * 6;
    p.style.cssText = `left:${Math.random()*100}vw;top:0;background:${clrs[i%clrs.length]};--drift:${drift}px;--dur:${.8+Math.random()*1.3}s;--dl:${Math.random()*.6}s;width:${size}px;height:${size}px;border-radius:${Math.random()>.5?'50%':'2px'};`;
    document.body.appendChild(p);
    setTimeout(() => p.remove(), 2500);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORM VALIDATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function valF(id) {
  const v = document.getElementById(id).value.trim();
  let ok = false;
  if (id === 'fname')  ok = v.length >= 2;
  if (id === 'femail') ok = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
  if (id === 'fphone') ok = /^[6-9]\d{9}$/.test(v);
  document.getElementById(id).classList.toggle('err', !ok);
  document.getElementById(id).classList.toggle('ok', ok);
  document.getElementById(id + 'E').classList.toggle('show', !ok && v.length > 0);
  return ok;
}

function valUTR() {
  const v = document.getElementById('utrI').value.trim();
  const ok = isUTR(v);
  document.getElementById('utrI').classList.toggle('err', !ok && v.length > 0);
  document.getElementById('utrI').classList.toggle('ok', ok);
  document.getElementById('utrE').classList.toggle('show', !ok && v.length > 0);
  return ok;
}

function isUTR(v) {
  if (!v || /[^a-zA-Z0-9]/.test(v)) return false;
  if (/^T/i.test(v) && v.length >= 12) return true;
  return /^\d{12,25}$/.test(v);
}

function validateDetails() {
  const ok = valF('fname') & valF('femail') & valF('fphone');
  if (ok) {
    bData.name  = document.getElementById('fname').value.trim();
    bData.email = document.getElementById('femail').value.trim();
    bData.phone = document.getElementById('fphone').value.trim();
    bData.qty   = qty;
    bData.amount = qty * CFG.ticketPrice;
    document.getElementById('payAmt').textContent = 'â‚¹' + bData.amount;
    document.getElementById('payInfo').textContent = 'for ' + bData.qty + ' ticket' + (bData.qty > 1 ? 's' : '');
    buildApps();
    goStep(3);
    startTmr();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAG & DROP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initDrag() {
  const z = document.getElementById('upZone');
  z.addEventListener('dragover', e => { e.preventDefault(); z.classList.add('drag'); });
  z.addEventListener('dragleave', () => z.classList.remove('drag'));
  z.addEventListener('drop', e => {
    e.preventDefault(); z.classList.remove('drag');
    const f = e.dataTransfer.files[0];
    if (f) processFile(f);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UPI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildApps() {
  const apps = [
    { n:'Google Pay', i:'ğŸŸ¢' }, { n:'PhonePe', i:'ğŸŸ£' }, { n:'Paytm', i:'ğŸ”µ' },
    { n:'BHIM UPI', i:'ğŸ›' }, { n:'Amazon Pay', i:'ğŸŸ ' }, { n:'Any UPI', i:'ğŸ’³' }
  ];
  document.getElementById('upiApps').innerHTML = apps.map((a, i) =>
    `<div class="app-btn" onclick="openApp()" style="animation:fup .3s ease ${i*.05}s both;cursor:pointer;">
      <span class="app-icon">${a.i}</span><span class="app-name">${a.n}</span>
    </div>`
  ).join('');
}

function openApp() {
  const amt = bData.amount || qty * CFG.ticketPrice;
  window.location.href = `upi://pay?pa=${CFG.upiId}&pn=${encodeURIComponent(CFG.payeeName)}&am=${amt}&cu=INR&tn=${encodeURIComponent('Ticket - ' + CFG.movieName)}`;
}

function copyUPI(btn) {
  navigator.clipboard.writeText(CFG.upiId).then(() => {
    btn.textContent = 'COPIED!'; btn.classList.add('copied');
    showToast('UPI ID copied!', 'success');
    setTimeout(() => { btn.textContent = 'COPY'; btn.classList.remove('copied'); }, 2000);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PAYMENT TIMER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startTmr() {
  tmrSecs = 600; clearInterval(tmrInt);
  tmrInt = setInterval(() => {
    tmrSecs--;
    const m = Math.floor(tmrSecs / 60), s = tmrSecs % 60;
    const el = document.getElementById('tmrD');
    el.textContent = String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
    el.classList.toggle('warn', tmrSecs <= 60);
    if (tmrSecs <= 0) {
      clearInterval(tmrInt);
      setStatusMsg('â° Time expired. Please restart.', 'error');
      document.getElementById('subBtn').disabled = true;
    }
  }, 1000);
}

function cancelPay() {
  clearInterval(tmrInt);
  bData = {}; ssFile = null; ocrAmt = false; ocrUpi = false;
  document.getElementById('utrI').value = '';
  document.getElementById('ssPrev').classList.remove('show');
  document.getElementById('ocrBox').classList.remove('show');
  document.getElementById('statusMsg').classList.remove('show');
  document.getElementById('subBtn').disabled = false;
  goStep(1);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILE UPLOAD + OCR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleFile(e) { const f = e.target.files[0]; if (f) processFile(f); }

function processFile(file) {
  if (file.size > 5 * 1024 * 1024) { showToast('File too large (max 5MB)', 'error'); return; }
  ssFile = file;
  const r = new FileReader();
  r.onload = e => { const p = document.getElementById('ssPrev'); p.src = e.target.result; p.classList.add('show'); };
  r.readAsDataURL(file);
  document.getElementById('ssE').classList.remove('show');
  runOCR(file);
}

async function runOCR(file) {
  const box = document.getElementById('ocrBox');
  const oP = document.getElementById('ocrP');
  const oA = document.getElementById('ocrA');
  const oU = document.getElementById('ocrU');
  box.classList.add('show');
  oP.style.display = 'flex'; oA.style.display = 'none'; oU.style.display = 'none';
  ocrAmt = false; ocrUpi = false;
  try {
    const res = await Tesseract.recognize(file, 'eng', { logger: () => {} });
    const txt = res.data.text;
    oP.style.display = 'none';
    const ea = bData.amount || qty * CFG.ticketPrice;
    ocrAmt = new RegExp(`[â‚¹Rs\\.]*\\s*${ea}([.\\s]|$)`, 'i').test(txt) ||
             new RegExp(`${ea}\\.?00`).test(txt);
    const upiBase = CFG.upiId.split('@')[0].toLowerCase();
    const upiDomain = CFG.upiId.split('@')[1]?.toLowerCase() || '';
    ocrUpi = txt.toLowerCase().includes(upiBase) || txt.toLowerCase().includes(upiDomain);
    oA.style.display = 'flex';
    oA.className = `ocr-item ${ocrAmt ? 'pass' : 'fail'}`;
    oA.textContent = ocrAmt ? `âœ“ Amount â‚¹${ea} found` : `âœ— Amount â‚¹${ea} not found`;
    oU.style.display = 'flex';
    oU.className = `ocr-item ${ocrUpi ? 'pass' : 'fail'}`;
    oU.textContent = ocrUpi ? 'âœ“ UPI ID verified' : 'âœ— UPI ID not detected';
    if (!ocrAmt || !ocrUpi)
      setStatusMsg('âš  Screenshot could not be fully verified. Admin will review manually.', 'info');
  } catch (e) {
    oP.style.display = 'none';
    box.classList.remove('show');
    console.warn('OCR error:', e);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RATE LIMIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function rateOk() {
  const now = Date.now();
  rateTs = rateTs.filter(t => now - t < 60000);
  if (rateTs.length >= 3) return false;
  rateTs.push(now); return true;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUBMIT BOOKING (all Supabase bugs fixed)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function submitBooking() {
  if (!rateOk()) { setStatusMsg('Too many attempts. Please wait a minute.', 'error'); return; }
  const utr = document.getElementById('utrI').value.trim();
  if (!isUTR(utr)) { document.getElementById('utrE').classList.add('show'); showToast('Enter a valid UTR', 'error'); return; }
  if (!ssFile) { document.getElementById('ssE').classList.add('show'); showToast('Upload payment screenshot', 'error'); return; }

  const btn = document.getElementById('subBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spn"></span>Processing...';

  try {
    // 1. Check UTR duplicate (no Range header â€” avoids 416 on empty tables)
    const existing = await sbGet(`bookings?utr=eq.${encodeURIComponent(utr)}&select=id`);
    if (existing && existing.length > 0) {
      setStatusMsg('âŒ This UTR has already been submitted.', 'error');
      btn.disabled = false; btn.innerHTML = 'Submit Booking';
      return;
    }

    // 2. Upload screenshot
    let ssUrl = '';
    try {
      const ext = ssFile.name.split('.').pop().toLowerCase();
      const fname = `${Date.now()}_${Math.random().toString(36).slice(2,8)}.${ext}`;
      ssUrl = await sbUpload('payment-screenshots', fname, ssFile);
    } catch (e) { console.warn('Screenshot upload failed:', e.message); }

    // 3. Generate booking ID
    const bid = 'RTD-' + Date.now().toString(36).toUpperCase().slice(-6) + '-' + Math.random().toString(36).slice(2,6).toUpperCase();

    // 4. Auto-approve logic
    const allVerified = ocrAmt && ocrUpi && ssUrl;
    const status = (CFG.autoApprove && allVerified) ? 'approved' : 'pending';

    // 5. Insert booking (no updated_at â€” only created_at exists in schema)
    await sbPost('bookings', {
      booking_id: bid,
      name: bData.name, email: bData.email, phone: bData.phone,
      ticket_qty: bData.qty, amount: bData.amount,
      utr, screenshot_url: ssUrl, status,
      ocr_verified: ocrAmt && ocrUpi,
      ocr_amount_match: ocrAmt,
      ocr_upi_match: ocrUpi,
      movie_name: CFG.movieName,
      event_date: CFG.eventDate
    });

    clearInterval(tmrInt);
    bData.bookingId = bid; bData.status = status; bData.utr = utr;
    renderTicket(bData);
    goStep(4);

    const sm = document.getElementById('successMsg');
    if (status === 'approved') {
      sm.textContent = 'âœ… Booking APPROVED! Your ticket is confirmed.';
      sm.className = 'smsg success show';
    } else {
      sm.textContent = 'ğŸ‰ Booking submitted! Pending verification â€” we\'ll notify you.';
      sm.className = 'smsg info show';
    }

  } catch (err) {
    console.error('Submit error:', err);
    setStatusMsg('Error: ' + err.message + '. Please try again.', 'error');
    btn.disabled = false; btn.innerHTML = 'Submit Booking';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER TICKET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTicket(d) {
  const card = document.getElementById('tktCard');
  const badge = d.status === 'approved'
    ? '<span class="sbadge approved">âœ“ Approved</span>'
    : '<span class="sbadge pending">â³ Pending</span>';
  if (d.status === 'approved') card.classList.add('glow-green');

  document.getElementById('tktBody').innerHTML = [
    ['Booking ID', `<span style="font-family:'Space Mono',monospace;font-size:.78rem;color:var(--or)">${d.bookingId}</span>`],
    ['Name', d.name], ['Email', `<span style="font-size:.78rem">${d.email}</span>`], ['Phone', d.phone],
    ['Movie', CFG.movieName], ['Date & Time', CFG.eventDateDisplay], ['Venue', CFG.venue || 'MBA Auditorium'],
    ['Tickets', `${d.qty} Ã— â‚¹${CFG.ticketPrice}`],
    ['Total Paid', `<span style="color:var(--or);font-size:1.05rem">â‚¹${d.amount}</span>`],
    ['UTR', `<span style="font-family:'Space Mono',monospace;font-size:.72rem">${d.utr}</span>`],
    ['Status', badge],
  ].map(([k, v], i) =>
    `<div class="tkt-row" style="animation-delay:${i*.04}s"><span class="tkt-k">${k}</span><span class="tkt-v">${v}</span></div>`
  ).join('');

  document.getElementById('qrDiv').innerHTML = '';
  new QRCode(document.getElementById('qrDiv'), {
    text: `RTD|${d.bookingId}|${d.name}|${d.qty}|${d.amount}|${d.status}`,
    width: 100, height: 100,
    colorDark: '#f07020', colorLight: '#100d09',
    correctLevel: QRCode.CorrectLevel.H
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CANVAS TICKET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawCanvas(data) {
  const cv = document.getElementById('tktCanvas');
  const W = 340, H = 720, sc = 2;
  cv.width = W * sc; cv.height = H * sc;
  cv.style.width = W + 'px'; cv.style.height = H + 'px';
  const ctx = cv.getContext('2d'); ctx.scale(sc, sc);

  // Background
  const bg = ctx.createLinearGradient(0, 0, W, H);
  bg.addColorStop(0, '#120e09'); bg.addColorStop(1, '#1c1510');
  ctx.fillStyle = bg; ctx.fillRect(0, 0, W, H);

  // Border
  ctx.strokeStyle = data.status === 'approved' ? 'rgba(63,184,118,.5)' : 'rgba(240,112,32,.5)';
  ctx.lineWidth = 1.5; rr(ctx, 3, 3, W-6, H-6, 13); ctx.stroke();

  // Top line
  const tl = ctx.createLinearGradient(0,0,W,0);
  tl.addColorStop(0,'transparent'); tl.addColorStop(.5, data.status==='approved'?'#3fb876':'#f07020'); tl.addColorStop(1,'transparent');
  ctx.fillStyle = tl; ctx.fillRect(0,0,W,2.5);

  // Film holes top
  filmHoles(ctx, W, 14);

  // Header
  ctx.fillStyle = 'rgba(240,112,32,.07)'; ctx.fillRect(0, 28, W, 85);
  ctx.fillStyle = 'rgba(240,112,32,.38)'; ctx.font = '8px Space Mono,monospace';
  ctx.textAlign = 'center'; ctx.fillText('REEL TO DEAL  Â·  MBA 2025', W/2, 46);
  ctx.fillStyle = '#f07020'; ctx.font = 'bold 20px Georgia,serif';
  ctx.fillText('ğŸ¬ ' + CFG.movieName.toUpperCase(), W/2, 70);
  ctx.fillStyle = '#8a7060'; ctx.font = '8px Space Mono,monospace';
  ctx.fillText(CFG.eventDateDisplay, W/2, 87);
  ctx.fillText((CFG.venue||'MBA Auditorium').toUpperCase(), W/2, 101);

  // Divider
  ctx.setLineDash([4,5]); ctx.strokeStyle = 'rgba(240,112,32,.2)'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(16, 114); ctx.lineTo(W-16, 114); ctx.stroke();
  ctx.setLineDash([]);

  // Rows
  const rows = [
    ['BOOKING ID', data.bookingId, '#f07020'],
    ['NAME', data.name, '#f0e8d8'],
    ['EMAIL', data.email, '#b8a888'],
    ['PHONE', data.phone, '#f0e8d8'],
    ['TICKETS', data.qty + ' Ã— â‚¹' + CFG.ticketPrice, '#f0e8d8'],
    ['TOTAL PAID', 'â‚¹' + data.amount, '#f07020'],
    ['UTR', data.utr, '#b8a888'],
    ['STATUS', (data.status||'PENDING').toUpperCase(), data.status==='approved'?'#3fb876':'#e8b840'],
  ];
  let y = 128;
  rows.forEach(([k,v,c]) => {
    ctx.fillStyle = '#503830'; ctx.font = '7.5px Space Mono,monospace';
    ctx.textAlign = 'left'; ctx.fillText(k, 18, y);
    ctx.fillStyle = c; ctx.font = '10.5px Space Mono,monospace';
    const vs = String(v||''); ctx.fillText(vs.length > 34 ? vs.slice(0,32)+'â€¦' : vs, 18, y+13);
    ctx.fillStyle = 'rgba(255,255,255,.035)'; ctx.fillRect(14, y+18, W-28, 1);
    y += 34;
  });

  // QR code
  ctx.setLineDash([4,5]); ctx.strokeStyle = 'rgba(240,112,32,.2)';
  ctx.beginPath(); ctx.moveTo(16,y+4); ctx.lineTo(W-16,y+4); ctx.stroke(); ctx.setLineDash([]);
  const qrEl = document.querySelector('#qrDiv img, #qrDiv canvas');
  if (qrEl) {
    const qs = 85, qx = (W-qs)/2, qy = y+14;
    ctx.fillStyle = 'rgba(16,13,9,.95)'; rr(ctx, qx-6, qy-6, qs+12, qs+12, 7); ctx.fill();
    try { ctx.drawImage(qrEl, qx, qy, qs, qs); } catch(e) {}
    ctx.fillStyle = '#504030'; ctx.font = '7px Space Mono,monospace';
    ctx.textAlign = 'center'; ctx.fillText('SCAN TO VERIFY', W/2, qy+qs+13);
  }

  // Film holes bottom
  filmHoles(ctx, W, H-14);

  // Watermark
  ctx.save(); ctx.globalAlpha = .03; ctx.fillStyle = '#f07020';
  ctx.font = 'bold 72px sans-serif'; ctx.textAlign = 'center';
  ctx.translate(W/2, H/2); ctx.rotate(-.3); ctx.fillText('RTD', 0, 0); ctx.restore();
}

function filmHoles(ctx, W, y) {
  ctx.fillStyle = 'rgba(240,112,32,.15)';
  for (let x = 12; x < W-12; x += 19) { rr(ctx, x, y-8, 12, 8, 2); ctx.fill(); }
}

function rr(ctx, x, y, w, h, r) {
  ctx.beginPath(); ctx.moveTo(x+r,y); ctx.lineTo(x+w-r,y); ctx.arcTo(x+w,y,x+w,y+r,r);
  ctx.lineTo(x+w,y+h-r); ctx.arcTo(x+w,y+h,x+w-r,y+h,r); ctx.lineTo(x+r,y+h);
  ctx.arcTo(x,y+h,x,y+h-r,r); ctx.lineTo(x,y+r); ctx.arcTo(x,y,x+r,y,r); ctx.closePath();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showSoftCopy() { drawCanvas(bData); openModal('softModal'); }
function closeSoftCopy() { closeModal('softModal'); }
function dlImage() {
  const a = document.createElement('a');
  a.download = 'ticket-' + (bData.bookingId||'RTD') + '.png';
  a.href = document.getElementById('tktCanvas').toDataURL('image/png', 1);
  a.click(); showToast('ğŸŸ Image saved!', 'success');
}

function openModal(id) { const m = document.getElementById(id); m.style.display='flex'; void m.offsetWidth; m.classList.add('show'); }
function closeModal(id) { const m = document.getElementById(id); m.classList.remove('show'); setTimeout(()=>m.style.display='none',300); }

function buildEmailBody() {
  return `Dear ${bData.name},\n\nThank you for booking!\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸŸ  TICKET DETAILS\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nBooking ID : ${bData.bookingId}\nMovie      : ${CFG.movieName}\nDate & Time: ${CFG.eventDateDisplay}\nVenue      : ${CFG.venue||'MBA Auditorium'}\nTickets    : ${bData.qty} Ã— â‚¹${CFG.ticketPrice}\nTotal Paid : â‚¹${bData.amount}\nUTR/TxnID  : ${bData.utr}\nStatus     : ${(bData.status||'PENDING').toUpperCase()}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n${bData.status==='approved'?'âœ… APPROVED â€” You are confirmed! Show ticket at entry.':'â³ PENDING â€” Under verification. We\'ll email you.'}\n\nâ€” Reel to Deal Â· MBA Fest 2025`;
}

function showEmailModal() { document.getElementById('emailPrev').textContent = buildEmailBody(); openModal('emailModal'); }
function closeEmailModal() { closeModal('emailModal'); }
function sendEmail() {
  const s = encodeURIComponent(`Your ${CFG.movieName} Ticket â€“ ${bData.bookingId}`);
  window.location.href = `mailto:${bData.email}?subject=${s}&body=${encodeURIComponent(buildEmailBody())}`;
  showToast('Opening email app...', 'success'); closeEmailModal();
}

function shareWA() {
  const msg = `ğŸ¬ *${CFG.movieName}* Ticket\n\nğŸŸ ID: ${bData.bookingId}\nğŸ‘¤ ${bData.name}\nğŸ“… ${CFG.eventDateDisplay}\nğŸ« ${bData.qty} Ã— â‚¹${CFG.ticketPrice} = â‚¹${bData.amount}\nâœ… ${(bData.status||'PENDING').toUpperCase()}\n\n_Reel to Deal Â· MBA Fest 2025_`;
  window.open('https://wa.me/?text=' + encodeURIComponent(msg), '_blank');
}

async function dlPDF() {
  const ev = event; if (ev) ev.target.textContent = 'â³...';
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation:'portrait', unit:'mm', format:'a5' });
  doc.setFillColor(10,8,6); doc.rect(0,0,148,210,'F');
  doc.setFillColor(22,16,10); doc.rect(0,0,148,42,'F');
  doc.setTextColor(240,112,32); doc.setFontSize(18); doc.setFont('helvetica','bold');
  doc.text('REEL TO DEAL', 74, 14, { align:'center' });
  doc.setFontSize(7); doc.setTextColor(138,112,80);
  doc.text(CFG.eventDateDisplay, 74, 22, { align:'center' });
  doc.setFontSize(10); doc.setTextColor(240,112,32);
  doc.text(CFG.movieName.toUpperCase(), 74, 32, { align:'center' });
  doc.setDrawColor(240,112,32); doc.setLineWidth(.25); doc.line(10,42,138,42);
  const rows2 = [
    ['BOOKING ID',bData.bookingId],['NAME',bData.name],['EMAIL',bData.email],
    ['PHONE',bData.phone],['VENUE',CFG.venue||'MBA Auditorium'],
    ['TICKETS',bData.qty+' Ã— â‚¹'+CFG.ticketPrice],['TOTAL','â‚¹'+bData.amount],
    ['UTR',bData.utr],['STATUS',(bData.status||'PENDING').toUpperCase()]
  ];
  let y2 = 52;
  rows2.forEach(([k,v]) => {
    doc.setFontSize(6); doc.setTextColor(120,90,60); doc.text(k, 12, y2);
    doc.setFontSize(8); doc.setTextColor(240,232,216); doc.text(String(v||''), 12, y2+5);
    doc.setDrawColor(40,30,20); doc.setLineWidth(.1); doc.line(10,y2+8.5,138,y2+8.5);
    y2 += 15;
  });
  const qrEl2 = document.querySelector('#qrDiv img, #qrDiv canvas');
  if (qrEl2) {
    try {
      const tc = document.createElement('canvas'); tc.width=150; tc.height=150;
      tc.getContext('2d').drawImage(qrEl2,0,0,150,150);
      doc.addImage(tc.toDataURL('image/png'),'PNG',59,y2+2,30,30);
      doc.setFontSize(5); doc.setTextColor(100,80,60);
      doc.text('SCAN TO VERIFY', 74.5, y2+36, {align:'center'});
    } catch(e) {}
  }
  doc.setFontSize(5); doc.setTextColor(45,35,25);
  doc.text('Reel to Deal Â· MBA Fest 2025 Â· Valid for event entry only', 74,206,{align:'center'});
  doc.save('ticket-' + (bData.bookingId||'RTD') + '.pdf');
  if (ev && ev.target) ev.target.textContent = 'ğŸ“„ PDF';
  showToast('PDF downloaded!', 'success');
}

function printTkt() { window.print(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setStatusMsg(msg, type) {
  const el = document.getElementById('statusMsg');
  el.textContent = msg; el.className = `smsg ${type} show`;
}

function showToast(msg, type = '') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = `toast ${type} show`;
  setTimeout(() => t.className = `toast ${type}`, 3200);
}

// BOOKING LOOKUP
async function lookupBooking(){
  const q=document.getElementById('lookupInput').value.trim();
  const res=document.getElementById('lookupResult');
  if(!q){showToast('Enter a Booking ID or UTR','info');return;}
  res.style.display='block';res.textContent='Looking up...';res.style.color='var(--muted)';
  try{
    let data=await sbFetch(`bookings?booking_id=eq.${encodeURIComponent(q)}&select=*`,{method:'GET'}).catch(()=>[]);
    if(!data||!data.length) data=await sbFetch(`bookings?utr=eq.${encodeURIComponent(q)}&select=*`,{method:'GET'}).catch(()=>[]);
    if(!data||!data.length){res.textContent='âŒ No booking found.';res.style.color='var(--red)';return;}
    const b=data[0];
    const sc={approved:'var(--green)',pending:'var(--yellow)',rejected:'var(--red)'}[b.status]||'var(--muted)';
    res.style.color='var(--text)';
    res.innerHTML=`<strong style="color:var(--orange)">${b.booking_id}</strong><br>Name: ${b.name}<br>Status: <strong style="color:${sc}">${(b.status||'').toUpperCase()}</strong><br>Amount: â‚¹${b.amount} Â· ${b.ticket_qty} ticket(s)`;
  }catch(e){res.textContent='Error: '+e.message;res.style.color='var(--red)';}
}

// PAYMENT SUB-STEPS
function setPSS(n){
  for(let i=1;i<=4;i++){
    const el=document.getElementById('pss'+i);if(!el)continue;
    el.className='pss-item'+(i===n?' active':i<n?' done':'');
    const dot=el.querySelector('.pss-dot');if(dot)dot.textContent=i<n?'âœ“':i;
    if(i<4){const ln=document.getElementById('psl'+i);if(ln)ln.className='pss-line'+(i<n?' done':'');}
  }
}

// BOOK ANOTHER
function bookAnother(){
  bData={};ssFile=null;ocrAmt=false;ocrUpi=false;qty=1;
  document.getElementById('qrcode').innerHTML='';
  document.getElementById('tktCard').className='tkt-card';
  document.getElementById('fname').value='';
  document.getElementById('femail').value='';
  document.getElementById('fphone').value='';
  ['fname','femail','fphone'].forEach(id=>{const el=document.getElementById(id);el.className='';});
  chgQty(0);goStep(1);
}

</script>
</body>
</html>
