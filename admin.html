<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Reel to Deal â€” Admin</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400&family=JetBrains+Mono:wght@300;400;500;700&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOKENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg:  #05040a;  --bg2: #09080f;
  --s1:  #100e18;  --s2:  #161422; --s3:  #1d1b2a; --s4:  #252233;
  --bdr: rgba(255,255,255,0.07);   --bdr2:rgba(255,255,255,0.12);
  --gold: #d4a843; --g2: #f0c760;  --g3: #fbe49a;
  --gg:  rgba(212,168,67,0.14);    --gr: rgba(212,168,67,0.3);
  --text:#ede8d8;  --muted:#8a7e6a; --faint:#3a3530;
  --grn: #3dd68c;  --grndim:rgba(61,214,140,0.13);
  --red: #f05252;  --reddim:rgba(240,82,82,0.13);
  --ylw: #fbbf24;  --ylwdim:rgba(251,191,36,0.13);
  --blu: #60a5fa;  --bludim:rgba(96,165,250,0.13);
  --prp: #a78bfa;  --prpdim:rgba(167,139,250,0.13);
  --sb:  220px;
}
*,*::before,*::after { margin:0;padding:0;box-sizing:border-box; }
html { font-size:15px; }
body { background:var(--bg); color:var(--text); font-family:'Outfit',sans-serif; min-height:100vh; display:flex; overflow-x:hidden; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOGIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#login {
  position:fixed; inset:0; z-index:9999;
  background:var(--bg);
  display:flex; align-items:center; justify-content:center;
}
.lbox {
  background:var(--s1); border:1px solid var(--gr);
  border-radius:22px; padding:40px;
  width:min(420px,93vw); position:relative; overflow:hidden;
  box-shadow:0 40px 80px rgba(0,0,0,0.7), 0 0 60px rgba(212,168,67,0.04);
}
.lbox::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; background:linear-gradient(90deg,transparent,var(--g2),var(--g3),var(--g2),transparent); }
.l-logo { font-family:'Playfair Display',serif; font-size:1.9rem; font-weight:900; text-align:center; margin-bottom:4px;
  background:linear-gradient(135deg,var(--g3),var(--g2),var(--gold));
  -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
.l-logo em { font-style:italic; }
.l-sub { text-align:center; font-family:'JetBrains Mono',monospace; font-size:0.6rem; letter-spacing:0.22em; text-transform:uppercase; color:var(--muted); margin-bottom:30px; }
.l-lbl { display:block; font-family:'JetBrains Mono',monospace; font-size:0.6rem; letter-spacing:0.15em; text-transform:uppercase; color:var(--muted); margin-bottom:7px; }
.l-inp { width:100%; padding:11px 13px; background:var(--s3); border:1px solid var(--bdr); border-radius:9px; color:var(--text); font-family:'Outfit',sans-serif; font-size:0.9rem; outline:none; transition:all 0.2s; margin-bottom:14px; }
.l-inp:focus { border-color:var(--gr); box-shadow:0 0 0 3px var(--gg); }
.l-btn { width:100%; padding:12px; background:linear-gradient(135deg,var(--gold),var(--g2)); border:none; border-radius:9px; color:var(--bg); font-family:'JetBrains Mono',monospace; font-size:0.78rem; letter-spacing:0.12em; text-transform:uppercase; font-weight:700; cursor:pointer; transition:all 0.25s; }
.l-btn:hover { transform:translateY(-1px); box-shadow:0 6px 20px rgba(212,168,67,0.3); }
.l-err { font-family:'JetBrains Mono',monospace; font-size:0.62rem; color:var(--red); text-align:center; margin-top:8px; display:none; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIDEBAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#sb {
  width:var(--sb); flex-shrink:0;
  position:fixed; left:0; top:0; bottom:0;
  background:var(--s1); border-right:1px solid var(--bdr);
  display:flex; flex-direction:column; z-index:100;
  transition:transform 0.3s;
}
@media(max-width:768px){ #sb{transform:translateX(-100%);} #sb.open{transform:translateX(0);} #main{margin-left:0!important;} }
.sb-top { padding:20px 18px 16px; border-bottom:1px solid var(--bdr); }
.sb-logo { font-family:'Playfair Display',serif; font-size:1rem; font-weight:700; color:var(--g2); }
.sb-logo em { font-style:italic; color:var(--g3); }
.sb-sub { font-family:'JetBrains Mono',monospace; font-size:0.52rem; letter-spacing:0.14em; text-transform:uppercase; color:var(--faint); margin-top:2px; }
.sb-nav { flex:1; padding:10px 8px; overflow-y:auto; }
.nav-sec { font-family:'JetBrains Mono',monospace; font-size:0.52rem; letter-spacing:0.18em; text-transform:uppercase; color:var(--faint); padding:11px 10px 4px; }
.nav-item {
  display:flex; align-items:center; gap:9px;
  padding:9px 11px; border-radius:9px; cursor:pointer;
  color:var(--muted); font-size:0.88rem; transition:all 0.2s;
  border:none; background:none; width:100%; text-align:left;
  font-family:'Outfit',sans-serif;
}
.nav-item:hover { background:rgba(255,255,255,0.04); color:var(--text); }
.nav-item.active { background:var(--gg); color:var(--g2); }
.nav-icon { font-size:0.95rem; flex-shrink:0; }
.nav-badge { margin-left:auto; background:var(--red); color:#fff; font-size:0.55rem; font-family:'JetBrains Mono',monospace; padding:2px 5px; border-radius:100px; min-width:16px; text-align:center; }
.sb-foot { padding:12px; border-top:1px solid var(--bdr); }
.sync-row { display:flex; align-items:center; gap:6px; font-family:'JetBrains Mono',monospace; font-size:0.6rem; color:var(--muted); margin-bottom:8px; }
.sdot { width:6px; height:6px; border-radius:50%; background:var(--grn); flex-shrink:0; }
.sdot.off { background:var(--red); }
.sdot:not(.off) { animation:sdotPulse 2.5s infinite; }
@keyframes sdotPulse { 0%,100%{box-shadow:0 0 0 0 rgba(61,214,140,0.4)} 50%{box-shadow:0 0 0 4px rgba(61,214,140,0)} }
.logout-btn { width:100%; padding:8px; background:var(--reddim); border:1px solid rgba(240,82,82,0.2); color:var(--red); font-family:'JetBrains Mono',monospace; font-size:0.62rem; letter-spacing:0.08em; text-transform:uppercase; border-radius:7px; cursor:pointer; transition:all 0.2s; }
.logout-btn:hover { background:rgba(240,82,82,0.2); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#main { flex:1; margin-left:var(--sb); display:flex; flex-direction:column; min-height:100vh; position:relative; z-index:1; }
.topnav {
  padding:13px 22px; background:rgba(5,4,10,0.9); backdrop-filter:blur(20px);
  border-bottom:1px solid var(--bdr);
  display:flex; align-items:center; justify-content:space-between;
  position:sticky; top:0; z-index:50;
}
.tn-left { display:flex; align-items:center; gap:11px; }
.tn-title { font-family:'Playfair Display',serif; font-size:1.05rem; font-weight:700; }
.hamburger { display:none; background:none; border:none; color:var(--text); font-size:1.25rem; cursor:pointer; }
@media(max-width:768px){ .hamburger{display:block;} }
.content { padding:22px; flex:1; max-width:1200px; width:100%; }
.page { display:none; }
.page.active { display:block; animation:pgIn 0.35s cubic-bezier(0.16,1,0.3,1) both; }
@keyframes pgIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:none} }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATS GRID
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stats-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(155px,1fr)); gap:12px; margin-bottom:20px; }
.sc {
  background:var(--s1); border:1px solid var(--bdr);
  border-radius:15px; padding:16px; position:relative; overflow:hidden;
  transition:all 0.3s; cursor:default;
}
.sc:hover { border-color:rgba(212,168,67,0.18); transform:translateY(-2px); }
.sc::after { content:''; position:absolute; top:0; left:0; right:0; height:2px; border-radius:15px 15px 0 0; }
.sc-gold::after  { background:linear-gradient(90deg,var(--gold),var(--g2)); }
.sc-green::after { background:linear-gradient(90deg,#16a34a,var(--grn)); }
.sc-red::after   { background:linear-gradient(90deg,#9b1c1c,var(--red)); }
.sc-blue::after  { background:linear-gradient(90deg,#1e3a8a,var(--blu)); }
.sc-yellow::after{ background:linear-gradient(90deg,#92400e,var(--ylw)); }
.sc-purple::after{ background:linear-gradient(90deg,#4c1d95,var(--prp)); }
.sc-icon { font-size:1.3rem; margin-bottom:9px; }
.sc-lbl { font-family:'JetBrains Mono',monospace; font-size:0.56rem; letter-spacing:0.12em; text-transform:uppercase; color:var(--muted); margin-bottom:4px; }
.sc-val { font-family:'Playfair Display',serif; font-size:1.8rem; font-weight:700; color:var(--text); transition:all 0.4s; }
.sc-val.bump { transform:scale(1.08); color:var(--g2); }
.sc-sub { font-family:'JetBrains Mono',monospace; font-size:0.56rem; color:var(--faint); margin-top:2px; }

/* Progress bar on stat */
.sc-bar { margin-top:8px; height:3px; background:var(--s3); border-radius:3px; overflow:hidden; }
.sc-bar-fill { height:100%; border-radius:3px; transition:width 0.8s cubic-bezier(0.16,1,0.3,1); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PANELS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.panel { background:var(--s1); border:1px solid var(--bdr); border-radius:16px; margin-bottom:18px; overflow:hidden; }
.panel-head { padding:14px 18px; border-bottom:1px solid var(--bdr); display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:8px; }
.panel-title { font-family:'Playfair Display',serif; font-size:0.98rem; font-weight:700; display:flex; align-items:center; gap:8px; }
.panel-body { padding:18px; }
.charts-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(270px,1fr)); gap:14px; margin-bottom:18px; }
.chart-box { background:var(--s1); border:1px solid var(--bdr); border-radius:16px; padding:18px; }
.chart-lbl { font-family:'JetBrains Mono',monospace; font-size:0.62rem; letter-spacing:0.12em; text-transform:uppercase; color:var(--gold); margin-bottom:12px; }
.chart-wrap { position:relative; height:176px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FILTER / SEARCH BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.fbar { display:flex; gap:7px; flex-wrap:wrap; align-items:center; }
.fbar-in { flex:1; min-width:180px; padding:8px 12px; background:var(--s3); border:1px solid var(--bdr); border-radius:8px; color:var(--text); font-family:'Outfit',sans-serif; font-size:0.85rem; outline:none; transition:all 0.2s; }
.fbar-in:focus { border-color:var(--gr); }
.fbar-btn { padding:8px 13px; background:var(--s3); border:1px solid var(--bdr); border-radius:8px; color:var(--muted); font-family:'JetBrains Mono',monospace; font-size:0.62rem; letter-spacing:0.05em; cursor:pointer; transition:all 0.2s; white-space:nowrap; }
.fbar-btn.active { background:var(--gg); border-color:var(--gr); color:var(--g2); }
.fbar-btn:hover:not(.active) { color:var(--g2); border-color:var(--gr); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tbl-wrap { overflow-x:auto; }
table { width:100%; border-collapse:collapse; font-size:0.83rem; }
thead th { padding:10px 12px; text-align:left; font-family:'JetBrains Mono',monospace; font-size:0.58rem; letter-spacing:0.1em; text-transform:uppercase; color:var(--faint); border-bottom:1px solid var(--bdr); white-space:nowrap; }
tbody tr { border-bottom:1px solid rgba(255,255,255,0.04); transition:background 0.15s; }
tbody tr:last-child { border:none; }
tbody tr:hover { background:rgba(255,255,255,0.02); }
td { padding:11px 12px; vertical-align:middle; }
.td-id { font-family:'JetBrains Mono',monospace; font-size:0.67rem; color:var(--gold); }
.td-name { font-weight:500; }
.td-email { font-family:'JetBrains Mono',monospace; font-size:0.65rem; color:var(--muted); }
.td-amt { font-family:'Playfair Display',serif; font-size:0.92rem; color:var(--g2); }
.td-amt.free { color:var(--grn); }
.td-date { font-family:'JetBrains Mono',monospace; font-size:0.62rem; color:var(--muted); white-space:nowrap; }
.cb { width:15px; height:15px; accent-color:var(--gold); cursor:pointer; }

/* Status badges */
.sbadge { display:inline-flex; align-items:center; gap:4px; padding:3px 9px; border-radius:100px; font-family:'JetBrains Mono',monospace; font-size:0.58rem; letter-spacing:0.07em; text-transform:uppercase; font-weight:600; white-space:nowrap; }
.sb-pending  { background:var(--ylwdim); color:var(--ylw); border:1px solid rgba(251,191,36,0.22); }
.sb-review   { background:var(--bludim); color:var(--blu); border:1px solid rgba(96,165,250,0.22); }
.sb-approved { background:var(--grndim); color:var(--grn); border:1px solid rgba(61,214,140,0.25); animation:sbGlow 2s infinite; }
.sb-rejected { background:var(--reddim); color:var(--red); border:1px solid rgba(240,82,82,0.22); }
.sb-free     { background:var(--grndim); color:var(--grn); border:1px solid rgba(61,214,140,0.25); }
@keyframes sbGlow { 0%,100%{box-shadow:0 0 4px rgba(61,214,140,0.1)} 50%{box-shadow:0 0 12px rgba(61,214,140,0.3)} }
.sd { width:5px; height:5px; border-radius:50%; background:currentColor; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ACTION BUTTONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.acts { display:flex; gap:4px; flex-wrap:wrap; }
.act { padding:4px 9px; border-radius:6px; border:none; cursor:pointer; font-family:'JetBrains Mono',monospace; font-size:0.58rem; letter-spacing:0.04em; transition:all 0.2s; font-weight:500; white-space:nowrap; }
.act-app { background:var(--grndim); color:var(--grn); border:1px solid rgba(61,214,140,0.2); }
.act-app:hover { background:rgba(61,214,140,0.2); }
.act-rev { background:var(--bludim); color:var(--blu); border:1px solid rgba(96,165,250,0.2); }
.act-rej { background:var(--reddim); color:var(--red); border:1px solid rgba(240,82,82,0.2); }
.act-rej:hover { background:rgba(240,82,82,0.2); }
.act-del { background:rgba(255,255,255,0.04); color:var(--muted); border:1px solid var(--bdr); }
.act-del:hover { background:var(--reddim); color:var(--red); }
.act-ss { background:var(--gg); color:var(--g2); border:1px solid var(--gr); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BULK BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#bulkBar { background:var(--s3); border:1px solid var(--gr); border-radius:10px; padding:10px 14px; display:none; align-items:center; gap:9px; flex-wrap:wrap; margin-bottom:11px; }
.bulk-cnt { font-family:'JetBrains Mono',monospace; font-size:0.7rem; color:var(--g2); margin-right:auto; }
.bulk-btn { padding:6px 13px; border-radius:7px; border:none; cursor:pointer; font-family:'JetBrains Mono',monospace; font-size:0.62rem; letter-spacing:0.05em; text-transform:uppercase; transition:all 0.2s; }
.bulk-approve { background:var(--grndim); color:var(--grn); border:1px solid rgba(61,214,140,0.22); }
.bulk-reject  { background:var(--reddim);  color:var(--red); border:1px solid rgba(240,82,82,0.22);  }
.bulk-delete  { background:var(--reddim);  color:var(--red); border:1px solid rgba(240,82,82,0.22);  }
.bulk-cancel  { background:var(--s4); color:var(--muted); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREENSHOT MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#ssModal { position:fixed; inset:0; z-index:1000; background:rgba(0,0,0,0.85); backdrop-filter:blur(14px); display:none; align-items:center; justify-content:center; padding:18px; }
#ssModal.open { display:flex; animation:fadeIn 0.2s ease; }
@keyframes fadeIn { from{opacity:0} to{opacity:1} }
.ss-box { background:var(--s2); border:1px solid var(--bdr2); border-radius:16px; overflow:hidden; max-width:580px; width:100%; max-height:90vh; display:flex; flex-direction:column; }
.ss-hd { padding:12px 16px; border-bottom:1px solid var(--bdr); display:flex; justify-content:space-between; align-items:center; font-family:'JetBrains Mono',monospace; font-size:0.68rem; letter-spacing:0.08em; text-transform:uppercase; color:var(--muted); }
.ss-close { background:none; border:none; color:var(--muted); font-size:1.1rem; cursor:pointer; transition:color 0.2s; }
.ss-close:hover { color:var(--red); }
#ssImg { width:100%; object-fit:contain; flex:1; max-height:calc(90vh - 50px); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETTINGS PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.settings-layout { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:16px; }
.s-group { margin-bottom:14px; }
.s-lbl { display:block; font-family:'JetBrains Mono',monospace; font-size:0.58rem; letter-spacing:0.15em; text-transform:uppercase; color:var(--muted); margin-bottom:6px; }
.s-inp { width:100%; padding:10px 12px; background:var(--s3); border:1px solid var(--bdr); border-radius:8px; color:var(--text); font-family:'Outfit',sans-serif; font-size:0.88rem; outline:none; transition:all 0.2s; }
.s-inp:focus { border-color:var(--gr); box-shadow:0 0 0 3px var(--gg); }
.s-inp-num { font-family:'JetBrains Mono',monospace; }
.toggle-row { display:flex; align-items:center; justify-content:space-between; padding:11px 0; border-bottom:1px solid var(--bdr); }
.toggle-row:last-child { border:none; }
.tog-info h4 { font-size:0.88rem; font-weight:500; margin-bottom:2px; }
.tog-info p  { font-family:'JetBrains Mono',monospace; font-size:0.58rem; color:var(--muted); }
.tog { position:relative; width:40px; height:22px; flex-shrink:0; }
.tog input { opacity:0; width:0; height:0; }
.tog-sl { position:absolute; cursor:pointer; inset:0; background:var(--s4); border-radius:22px; transition:0.3s; }
.tog-sl::before { content:''; position:absolute; height:16px; width:16px; left:3px; bottom:3px; background:white; border-radius:50%; transition:0.3s; }
.tog input:checked + .tog-sl { background:var(--grn); }
.tog input:checked + .tog-sl::before { transform:translateX(18px); }
/* Availability indicators */
.avail-bar {
  background:var(--s3); border:1px solid var(--bdr);
  border-radius:10px; padding:14px 16px; margin-bottom:14px;
}
.avail-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
.avail-row:last-child { margin:0; }
.avail-k { font-family:'JetBrains Mono',monospace; font-size:0.62rem; color:var(--muted); letter-spacing:0.06em; }
.avail-v { font-family:'JetBrains Mono',monospace; font-size:0.78rem; color:var(--text); font-weight:600; }
.avail-v.green { color:var(--grn); }
.avail-v.red   { color:var(--red); }
.avail-v.gold  { color:var(--g2); }
.avail-prog { margin-top:4px; height:4px; background:var(--s4); border-radius:4px; overflow:hidden; }
.avail-fill { height:100%; border-radius:4px; background:linear-gradient(90deg,var(--gold),var(--g2)); transition:width 0.6s cubic-bezier(0.16,1,0.3,1); }
.avail-fill.free { background:linear-gradient(90deg,var(--grn),#20c770); }
/* Danger zone */
.danger-zone { background:var(--reddim); border:1px solid rgba(240,82,82,0.18); border-radius:14px; padding:18px; }
.danger-title { font-family:'JetBrains Mono',monospace; font-size:0.68rem; letter-spacing:0.14em; text-transform:uppercase; color:var(--red); margin-bottom:12px; }
.danger-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(170px,1fr)); gap:9px; }
.danger-btn { padding:9px 12px; background:rgba(240,82,82,0.09); border:1px solid rgba(240,82,82,0.22); border-radius:8px; color:var(--red); font-family:'JetBrains Mono',monospace; font-size:0.62rem; letter-spacing:0.05em; text-transform:uppercase; cursor:pointer; transition:all 0.2s; }
.danger-btn:hover { background:rgba(240,82,82,0.18); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUTTONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn { display:inline-flex; align-items:center; justify-content:center; gap:7px; padding:8px 16px; border-radius:8px; border:none; cursor:pointer; font-family:'JetBrains Mono',monospace; font-size:0.68rem; letter-spacing:0.08em; text-transform:uppercase; transition:all 0.2s; }
.btn-gold { background:linear-gradient(135deg,var(--gold),var(--g2)); color:var(--bg); font-weight:700; }
.btn-gold:hover { transform:translateY(-1px); box-shadow:0 4px 14px rgba(212,168,67,0.25); }
.btn-ghost { background:transparent; border:1.5px solid var(--bdr2)!important; border:none; color:var(--muted); }
.btn-ghost:hover { border-color:var(--gr)!important; color:var(--g2); }
.spin { display:inline-block; width:13px; height:13px; border:2px solid rgba(255,255,255,0.2); border-top-color:currentColor; border-radius:50%; animation:sp360 0.6s linear infinite; }
@keyframes sp360 { to{transform:rotate(360deg)} }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#toasts { position:fixed; top:18px; right:18px; z-index:9999; display:flex; flex-direction:column; gap:7px; pointer-events:none; }
.toast { background:var(--s2); border:1px solid var(--bdr2); border-radius:10px; padding:11px 16px; font-family:'JetBrains Mono',monospace; font-size:0.68rem; letter-spacing:0.04em; color:var(--text); pointer-events:auto; animation:toastIn 0.3s cubic-bezier(0.16,1,0.3,1) both; box-shadow:0 8px 28px rgba(0,0,0,0.5); }
.toast.ok  { border-color:rgba(61,214,140,0.3); background:rgba(61,214,140,0.08); color:var(--grn); }
.toast.err { border-color:rgba(240,82,82,0.3);  background:rgba(240,82,82,0.08);  color:var(--red); }
.toast.inf { border-color:rgba(212,168,67,0.3);  background:rgba(212,168,67,0.06);  color:var(--g2); }
@keyframes toastIn { from{opacity:0;transform:translateX(16px)} to{opacity:1;transform:none} }
.toast.bye { animation:toastOut 0.22s ease forwards; }
@keyframes toastOut { to{opacity:0;transform:translateX(16px)} }

/* Empty */
.empty { text-align:center; padding:44px 20px; }
.empty-ico { font-size:2.3rem; margin-bottom:10px; opacity:0.3; }
.empty-txt { font-family:'JetBrains Mono',monospace; font-size:0.68rem; letter-spacing:0.07em; text-transform:uppercase; color:var(--faint); }
/* Skeleton */
.skel { background:linear-gradient(90deg,var(--s2) 25%,var(--s3) 50%,var(--s2) 75%); background-size:400% 100%; animation:skel 1.4s infinite; border-radius:6px; }
@keyframes skel { from{background-position:100%} to{background-position:-100%} }
</style>
</head>
<body>

<!-- â”€â”€ LOGIN â”€â”€ -->
<div id="login">
  <div class="lbox">
    <div class="l-logo">Reel <em>to</em> Deal</div>
    <div class="l-sub">Admin Dashboard</div>
    <label class="l-lbl">Username</label>
    <input class="l-inp" id="lu" type="text" placeholder="admin" autocomplete="username">
    <label class="l-lbl">Password</label>
    <input class="l-inp" id="lp" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeydown="if(event.key==='Enter')doLogin()">
    <button class="l-btn" onclick="doLogin()">Sign In â†’</button>
    <div class="l-err" id="lerr">Invalid credentials. Try again.</div>
  </div>
</div>

<!-- â”€â”€ SCREENSHOT MODAL â”€â”€ -->
<div id="ssModal" onclick="if(event.target===this)closeSS()">
  <div class="ss-box">
    <div class="ss-hd"><span>Payment Screenshot</span><button class="ss-close" onclick="closeSS()">âœ•</button></div>
    <img id="ssImg" alt="Screenshot">
  </div>
</div>

<!-- â”€â”€ TOASTS â”€â”€ -->
<div id="toasts"></div>

<!-- â”€â”€ SIDEBAR â”€â”€ -->
<nav id="sb">
  <div class="sb-top">
    <div class="sb-logo">Reel <em>to</em> Deal</div>
    <div class="sb-sub">Admin Panel v2</div>
  </div>
  <div class="sb-nav">
    <div class="nav-sec">Main</div>
    <button class="nav-item active" data-pg="dashboard" onclick="goPg('dashboard',this)">
      <span class="nav-icon">ğŸ“Š</span>Dashboard
    </button>
    <button class="nav-item" data-pg="tickets" onclick="goPg('tickets',this)">
      <span class="nav-icon">ğŸŸ</span>Tickets
      <span class="nav-badge" id="pendBadge" style="display:none">0</span>
    </button>
    <div class="nav-sec" style="margin-top:5px">Config</div>
    <button class="nav-item" data-pg="settings" onclick="goPg('settings',this)">
      <span class="nav-icon">âš™ï¸</span>Settings
    </button>
    <button class="nav-item" data-pg="analytics" onclick="goPg('analytics',this)">
      <span class="nav-icon">ğŸ“ˆ</span>Analytics
    </button>
  </div>
  <div class="sb-foot">
    <div class="sync-row"><div class="sdot" id="adSyncDot"></div><span id="adSyncLbl">Connectingâ€¦</span></div>
    <button class="logout-btn" onclick="doLogout()">â† Sign Out</button>
  </div>
</nav>

<!-- â”€â”€ MAIN â”€â”€ -->
<main id="main" style="display:none">
  <div class="topnav">
    <div class="tn-left">
      <button class="hamburger" onclick="toggleSb()">â˜°</button>
      <div class="tn-title" id="pgTitle">Dashboard</div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-ghost" onclick="refreshAll()">âŸ³ Refresh</button>
    </div>
  </div>

  <div class="content">

    <!-- â”€â”€â”€ DASHBOARD â”€â”€â”€ -->
    <div class="page active" id="pg-dashboard">
      <div class="stats-grid" id="statsGrid">
        <div class="sc sc-gold">
          <div class="sc-icon">ğŸŸ</div><div class="sc-lbl">Tickets Sold</div>
          <div class="sc-val" id="ds-sold">â€”</div>
          <div class="sc-bar"><div class="sc-bar-fill" id="ds-sold-bar" style="background:linear-gradient(90deg,var(--gold),var(--g2));width:0%"></div></div>
        </div>
        <div class="sc sc-purple">
          <div class="sc-icon">ğŸ“‹</div><div class="sc-lbl">Total Capacity</div>
          <div class="sc-val" id="ds-total">â€”</div>
          <div class="sc-sub" id="ds-remaining">â€” remaining</div>
        </div>
        <div class="sc sc-green">
          <div class="sc-icon">âœ¨</div><div class="sc-lbl">Free Used</div>
          <div class="sc-val" id="ds-free-used">â€”</div>
          <div class="sc-bar"><div class="sc-bar-fill" id="ds-free-bar" style="background:linear-gradient(90deg,var(--grn),#20c770);width:0%"></div></div>
        </div>
        <div class="sc sc-yellow">
          <div class="sc-icon">â³</div><div class="sc-lbl">Pending</div>
          <div class="sc-val" id="ds-pending">â€”</div>
        </div>
        <div class="sc sc-red">
          <div class="sc-icon">âŒ</div><div class="sc-lbl">Rejected</div>
          <div class="sc-val" id="ds-rejected">â€”</div>
        </div>
        <div class="sc sc-blue">
          <div class="sc-icon">ğŸ’°</div><div class="sc-lbl">Revenue</div>
          <div class="sc-val" id="ds-revenue">â€”</div>
        </div>
      </div>

      <div class="charts-grid">
        <div class="chart-box">
          <div class="chart-lbl">Status Breakdown</div>
          <div class="chart-wrap"><canvas id="cStatus"></canvas></div>
        </div>
        <div class="chart-box">
          <div class="chart-lbl">Daily Bookings (7 days)</div>
          <div class="chart-wrap"><canvas id="cDaily"></canvas></div>
        </div>
        <div class="chart-box">
          <div class="chart-lbl">Free vs Paid Tickets</div>
          <div class="chart-wrap"><canvas id="cFreeVsPaid"></canvas></div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-head">
          <div class="panel-title">â³ Pending Verification</div>
          <button class="btn btn-ghost" onclick="goPg('tickets',document.querySelector('[data-pg=tickets]'))">View All</button>
        </div>
        <div class="panel-body">
          <div class="tbl-wrap">
            <table>
              <thead><tr><th>Ticket ID</th><th>Name</th><th>Qty</th><th>Amount</th><th>Type</th><th>Date</th><th>Actions</th></tr></thead>
              <tbody id="pendingBody"><tr><td colspan="7" style="text-align:center;padding:24px"><div class="spin" style="margin:auto"></div></td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- â”€â”€â”€ TICKETS â”€â”€â”€ -->
    <div class="page" id="pg-tickets">
      <div id="bulkBar">
        <span class="bulk-cnt" id="bulkCnt">0 selected</span>
        <button class="bulk-btn bulk-approve" onclick="bulkDo('approved')">âœ… Approve</button>
        <button class="bulk-btn bulk-reject"  onclick="bulkDo('rejected')">âŒ Reject</button>
        <button class="bulk-btn bulk-delete"  onclick="bulkDo('delete')">ğŸ—‘ Delete</button>
        <button class="bulk-btn bulk-cancel"  onclick="clearSel()">Cancel</button>
      </div>

      <div class="panel">
        <div class="panel-head">
          <div class="panel-title">ğŸŸ All Tickets</div>
          <div class="fbar">
            <input class="fbar-in" id="searchIn" placeholder="Search ID, name, emailâ€¦" oninput="filterTix()">
            <button class="fbar-btn active" data-f="all"      onclick="setFilter('all',this)">All</button>
            <button class="fbar-btn"        data-f="pending"  onclick="setFilter('pending',this)">Pending</button>
            <button class="fbar-btn"        data-f="review"   onclick="setFilter('review',this)">Review</button>
            <button class="fbar-btn"        data-f="approved" onclick="setFilter('approved',this)">Approved</button>
            <button class="fbar-btn"        data-f="rejected" onclick="setFilter('rejected',this)">Rejected</button>
            <button class="fbar-btn"        data-f="free"     onclick="setFilter('free',this)">âœ¨ Free</button>
          </div>
        </div>
        <div class="panel-body" style="padding:0">
          <div class="tbl-wrap">
            <table>
              <thead>
                <tr>
                  <th><input type="checkbox" class="cb" id="selAll" onchange="toggleSelAll(this)"></th>
                  <th>Ticket ID</th><th>Name / Email</th><th>Qty</th><th>Amount</th>
                  <th>Type</th><th>Status</th><th>Date</th><th>Actions</th>
                </tr>
              </thead>
              <tbody id="tixBody">
                <tr><td colspan="9" style="text-align:center;padding:32px"><div class="spin" style="margin:auto"></div></td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- â”€â”€â”€ ANALYTICS â”€â”€â”€ -->
    <div class="page" id="pg-analytics">
      <div class="stats-grid" id="analyticsStats"></div>
      <div class="charts-grid" style="grid-template-columns:1fr">
        <div class="chart-box">
          <div class="chart-lbl">Revenue Over Time (14 days)</div>
          <div class="chart-wrap" style="height:220px"><canvas id="cRevenue"></canvas></div>
        </div>
      </div>
      <div class="charts-grid">
        <div class="chart-box">
          <div class="chart-lbl">Ticket Type Split</div>
          <div class="chart-wrap"><canvas id="cTypeSplit"></canvas></div>
        </div>
        <div class="chart-box">
          <div class="chart-lbl">Bookings by Hour</div>
          <div class="chart-wrap"><canvas id="cHourly"></canvas></div>
        </div>
      </div>
    </div>

    <!-- â”€â”€â”€ SETTINGS â”€â”€â”€ -->
    <div class="page" id="pg-settings">
      <!-- Live availability widget -->
      <div class="avail-bar" id="availWidget">
        <div class="avail-row">
          <span class="avail-k">Total Capacity</span>
          <span class="avail-v gold" id="av-total">â€”</span>
        </div>
        <div class="avail-row">
          <span class="avail-k">Tickets Sold</span>
          <span class="avail-v" id="av-sold">â€”</span>
        </div>
        <div class="avail-prog"><div class="avail-fill" id="av-soldBar" style="width:0%"></div></div>
        <div class="avail-row" style="margin-top:10px">
          <span class="avail-k">Free Tickets Limit</span>
          <span class="avail-v green" id="av-free">â€”</span>
        </div>
        <div class="avail-row">
          <span class="avail-k">Free Used</span>
          <span class="avail-v" id="av-freeUsed">â€”</span>
        </div>
        <div class="avail-prog"><div class="avail-fill free" id="av-freeBar" style="width:0%"></div></div>
        <div class="avail-row" style="margin-top:10px">
          <span class="avail-k">Remaining Seats</span>
          <span class="avail-v" id="av-remaining" style="color:var(--grn)">â€”</span>
        </div>
        <div class="avail-row">
          <span class="avail-k">Free Left</span>
          <span class="avail-v" id="av-freeLeft" style="color:var(--grn)">â€”</span>
        </div>
      </div>

      <div class="settings-layout">
        <div class="panel">
          <div class="panel-head"><div class="panel-title">ğŸ¬ Event & Pricing</div></div>
          <div class="panel-body">
            <div class="s-group">
              <label class="s-lbl">Event Name</label>
              <input class="s-inp" id="cfg-name" placeholder="Reel to Deal">
            </div>
            <div class="s-group">
              <label class="s-lbl">Venue</label>
              <input class="s-inp" id="cfg-venue" placeholder="MBA Auditorium">
            </div>
            <div class="s-group">
              <label class="s-lbl">Event Date Display</label>
              <input class="s-inp" id="cfg-date" placeholder="Feb 17, 2025 Â· 2:00 PM">
            </div>
            <div class="s-group">
              <label class="s-lbl">Ticket Price (â‚¹)</label>
              <input class="s-inp s-inp-num" id="cfg-price" type="number" min="0" placeholder="100">
            </div>
            <div class="s-group">
              <label class="s-lbl">UPI ID</label>
              <input class="s-inp" id="cfg-upi" placeholder="yourname@upi">
            </div>
            <button class="btn btn-gold" onclick="saveEventCfg()" style="width:100%;padding:11px 0">Save Event Config</button>
          </div>
        </div>

        <div class="panel">
          <div class="panel-head"><div class="panel-title">ğŸ« Ticket Limits</div></div>
          <div class="panel-body">
            <div class="s-group">
              <label class="s-lbl">Total Ticket Capacity</label>
              <input class="s-inp s-inp-num" id="cfg-total" type="number" min="1" placeholder="200">
            </div>
            <div class="s-group">
              <label class="s-lbl">Free Tickets Limit</label>
              <input class="s-inp s-inp-num" id="cfg-free" type="number" min="0" placeholder="50">
            </div>
            <div class="s-group">
              <label class="s-lbl">Free Tickets Used <small style="color:var(--muted)">(read-only)</small></label>
              <input class="s-inp s-inp-num" id="cfg-free-used" type="number" readonly style="opacity:0.5">
            </div>
            <div class="s-group">
              <label class="s-lbl">Tickets Sold <small style="color:var(--muted)">(read-only)</small></label>
              <input class="s-inp s-inp-num" id="cfg-sold" type="number" readonly style="opacity:0.5">
            </div>
            <button class="btn btn-gold" onclick="saveLimits()" style="width:100%;padding:11px 0">Save Limits</button>
          </div>
        </div>

        <div class="panel">
          <div class="panel-head"><div class="panel-title">ğŸ”§ Booking Controls</div></div>
          <div class="panel-body">
            <div class="toggle-row">
              <div class="tog-info"><h4>Accept Bookings</h4><p>Enable or disable ticket booking</p></div>
              <label class="tog"><input type="checkbox" id="tog-booking" checked><span class="tog-sl"></span></label>
            </div>
            <div style="margin-top:14px;padding:12px;background:var(--s3);border-radius:8px;font-family:'JetBrains Mono',monospace;font-size:0.62rem;color:var(--muted);line-height:1.6">
              âš  Disabling bookings will show a "Paused" message on the user site.<br>
              Free tickets are auto-deducted when a booking is submitted.
            </div>
            <button class="btn btn-gold" onclick="saveToggles()" style="width:100%;margin-top:14px;padding:11px 0">Save Controls</button>
          </div>
        </div>

        <div class="panel">
          <div class="panel-head"><div class="panel-title">ğŸ” Admin Security</div></div>
          <div class="panel-body">
            <div class="s-group"><label class="s-lbl">New Password</label><input class="s-inp" id="newpw" type="password" placeholder="New password"></div>
            <div class="s-group"><label class="s-lbl">Confirm Password</label><input class="s-inp" id="conpw" type="password" placeholder="Confirm password"></div>
            <button class="btn btn-gold" onclick="changePw()" style="width:100%;padding:11px 0">Update Password</button>
          </div>
        </div>
      </div>

      <!-- Danger Zone -->
      <div class="danger-zone" style="margin-top:4px">
        <div class="danger-title">âš  Danger Zone â€” Irreversible Actions</div>
        <div class="danger-grid">
          <button class="danger-btn" onclick="dangerOp('reset-free')">ğŸ”„ Reset Free Counter</button>
          <button class="danger-btn" onclick="dangerOp('reset-sold')">ğŸ”„ Reset Sold Counter</button>
          <button class="danger-btn" onclick="dangerOp('clear-pending')">ğŸ—‘ Clear Pending</button>
          <button class="danger-btn" onclick="dangerOp('clear-rejected')">ğŸ—‘ Clear Rejected</button>
          <button class="danger-btn" onclick="dangerOp('clear-all')">ğŸ’¥ Delete ALL Tickets</button>
          <button class="danger-btn" onclick="dangerOp('export-csv')" style="background:rgba(212,168,67,0.08);border-color:var(--gr);color:var(--g2)">ğŸ“¤ Export CSV</button>
        </div>
      </div>
    </div>

  </div><!-- /content -->
</main>

<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUPABASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SB_URL='https://yhrfpcwehtqsppoifhog.supabase.co';
const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlocmZwY3dlaHRxc3Bwb2lmaG9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1NzQ5MDAsImV4cCI6MjA4NzE1MDkwMH0.Ml1V2zc8j3XCZIuILuapy2Cs4jcBl0i6sHKxFFl6Sqo';
const H={'apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY,'Content-Type':'application/json','Prefer':'return=representation'};
const DB={
  async get(t,q='')  { const r=await fetch(`${SB_URL}/rest/v1/${t}?${q}`,{headers:H}); if(!r.ok)throw new Error(await r.text()); return r.json(); },
  async post(t,b)    { const r=await fetch(`${SB_URL}/rest/v1/${t}`,{method:'POST',headers:H,body:JSON.stringify(b)}); if(!r.ok)throw new Error(await r.text()); return r.json(); },
  async patch(t,q,b) { const r=await fetch(`${SB_URL}/rest/v1/${t}?${q}`,{method:'PATCH',headers:H,body:JSON.stringify(b)}); if(!r.ok)throw new Error(await r.text()); return r.json(); },
  async del(t,q)     { const r=await fetch(`${SB_URL}/rest/v1/${t}?${q}`,{method:'DELETE',headers:H}); if(!r.ok)throw new Error(await r.text()); return true; }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const G = { cfg:{}, tickets:[], filtered:[], filter:'all', search:'', selected:new Set(), charts:{} };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ADMIN_USER = 'admin';
const DEFAULT_PW = 'admin123';

function doLogin() {
  const u=_v('lu'), p=_v('lp');
  const pw = localStorage.getItem('rtd_admin_pw')||DEFAULT_PW;
  if (u===ADMIN_USER && p===pw) {
    _el('login').style.display='none';
    _el('main').style.display='flex';
    _el('main').style.flexDirection='column';
    init();
  } else {
    _el('lerr').style.display='block';
    _el('lp').value='';
    setTimeout(()=>_el('lerr').style.display='none', 2800);
  }
}
function doLogout() { _el('login').style.display='flex'; _el('main').style.display='none'; _el('lp').value=''; }
function changePw() {
  const np=_v('newpw'), cp=_v('conpw');
  if (!np||np!==cp) { toast('Passwords do not match','err'); return; }
  if (np.length<6) { toast('Min. 6 characters required','err'); return; }
  localStorage.setItem('rtd_admin_pw',np);
  toast('Password updated âœ“','ok');
  _el('newpw').value=''; _el('conpw').value='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
  await loadAll();
  loadSettingsForm();
  startPoll();
}

async function loadAll() {
  try {
    const [cfg] = await DB.get('settings','id=eq.1&select=*');
    if (cfg) G.cfg=cfg;
    G.tickets = await DB.get('tickets','order=created_at.desc&select=*');
    setSync(true);
  } catch(e) { setSync(false); console.warn(e); }
  renderDash();
  renderTixTable();
  updatePendBadge();
  updateAvailWidget();
}

function refreshAll() { loadAll(); toast('Refreshed âœ“','ok'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  POLLING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startPoll() {
  setInterval(async()=>{
    try {
      const [cfg]=await DB.get('settings','id=eq.1&select=*');
      if(cfg) G.cfg=cfg;
      const fresh=await DB.get('tickets','order=created_at.desc&select=*');
      if(fresh.length!==G.tickets.length||JSON.stringify(fresh.map(t=>t.status))!==JSON.stringify(G.tickets.map(t=>t.status))) {
        G.tickets=fresh;
        renderDash(); renderTixTable(); updatePendBadge();
      }
      G.cfg=cfg; updateAvailWidget();
      setSync(true);
    } catch(e){ setSync(false); }
  }, 7000);
}

function setSync(ok) {
  _el('adSyncDot').className='sdot'+(ok?'':' off');
  _el('adSyncLbl').textContent=ok?'Live âœ“':'Offline';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goPg(name,btn) {
  $$('.page').forEach(p=>p.classList.remove('active'));
  _el(`pg-${name}`).classList.add('active');
  $$('.nav-item').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  const titles={dashboard:'Dashboard',tickets:'Ticket Management',settings:'Settings & Controls',analytics:'Analytics'};
  _el('pgTitle').textContent=titles[name]||name;
  if(name==='analytics') renderAnalytics();
  if(name==='settings') loadSettingsForm();
}
function toggleSb() { _el('sb').classList.toggle('open'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDash() {
  const t=G.tickets, c=G.cfg;
  const pending  = t.filter(x=>x.status==='pending').length;
  const review   = t.filter(x=>x.status==='review').length;
  const approved = t.filter(x=>x.status==='approved').length;
  const rejected = t.filter(x=>x.status==='rejected').length;
  const freeUsed = c.free_used||0;
  const revenue  = t.filter(x=>x.status==='approved'&&!x.is_free).reduce((s,x)=>s+(+x.amount||0),0);
  const remaining = Math.max(0,(c.total_tickets||200)-(c.tickets_sold||0));
  const soldPct  = Math.min(100,Math.round(((c.tickets_sold||0)/(c.total_tickets||200))*100));
  const freePct  = Math.min(100,Math.round((freeUsed/Math.max(1,c.free_tickets||50))*100));

  bumpVal('ds-sold',     c.tickets_sold||0);
  bumpVal('ds-total',    c.total_tickets||200);
  bumpVal('ds-free-used',freeUsed);
  bumpVal('ds-pending',  pending);
  bumpVal('ds-rejected', rejected);
  _t('ds-revenue','â‚¹'+(revenue.toLocaleString('en-IN')));
  _t('ds-remaining', remaining+' remaining');
  _el('ds-sold-bar').style.width = soldPct+'%';
  _el('ds-free-bar').style.width = freePct+'%';

  // Pending table
  const pend = t.filter(x=>x.status==='pending').slice(0,6);
  _el('pendingBody').innerHTML = pend.length
    ? pend.map(tk=>`
        <tr>
          <td class="td-id">${tk.ticket_id}</td>
          <td class="td-name">${tk.user_name}</td>
          <td style="text-align:center">${tk.quantity}</td>
          <td class="td-amt ${tk.is_free?'free':''}">${tk.is_free?'FREE âœ¨':'â‚¹'+tk.amount}</td>
          <td>${tk.is_free?'<span class="sbadge sb-free"><div class="sd"></div>Free</span>':'<span style="font-family:JetBrains Mono,monospace;font-size:0.65rem;color:var(--muted)">Paid</span>'}</td>
          <td class="td-date">${fmtDate(tk.created_at)}</td>
          <td><div class="acts">
            <button class="act act-app" onclick="updStatus('${tk.id}','approved')">âœ…</button>
            <button class="act act-rev" onclick="updStatus('${tk.id}','review')">ğŸ”</button>
            <button class="act act-rej" onclick="updStatus('${tk.id}','rejected')">âŒ</button>
            ${tk.screenshot_url?`<button class="act act-ss" onclick="viewSS('${tk.screenshot_url}')">ğŸ“¸</button>`:''}
          </div></td>
        </tr>`).join('')
    : '<tr><td colspan="7"><div class="empty"><div class="empty-ico">âœ…</div><div class="empty-txt">No pending tickets</div></div></td></tr>';

  renderStatusChart(pending,review,approved,rejected);
  renderDailyChart();
  renderFreeVsPaidChart();
}

function renderStatusChart(p,rv,a,rj) {
  const ctx=_el('cStatus'); if(!ctx) return;
  if(G.charts.status) G.charts.status.destroy();
  G.charts.status=new Chart(ctx,{type:'doughnut',data:{
    labels:['Pending','Review','Approved','Rejected'],
    datasets:[{data:[p,rv,a,rj],backgroundColor:['rgba(251,191,36,0.7)','rgba(96,165,250,0.7)','rgba(61,214,140,0.7)','rgba(240,82,82,0.7)'],borderColor:'#09080f',borderWidth:2}]
  },options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#8a7e6a',font:{family:'JetBrains Mono',size:10}}}}}});
}

function renderDailyChart() {
  const days=Array.from({length:7},(_,i)=>{const d=new Date();d.setDate(d.getDate()-i);return d.toISOString().slice(0,10);}).reverse();
  const counts=days.map(day=>G.tickets.filter(t=>t.created_at?.startsWith(day)).length);
  const ctx=_el('cDaily'); if(!ctx) return;
  if(G.charts.daily) G.charts.daily.destroy();
  G.charts.daily=new Chart(ctx,{type:'bar',data:{
    labels:days.map(d=>new Date(d).toLocaleDateString('en-IN',{month:'short',day:'numeric'})),
    datasets:[{label:'Bookings',data:counts,backgroundColor:'rgba(212,168,67,0.45)',borderColor:'rgba(212,168,67,0.8)',borderRadius:5,borderWidth:1}]
  },options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#8a7e6a',font:{family:'JetBrains Mono',size:9}},grid:{color:'rgba(255,255,255,0.03)'}},y:{ticks:{color:'#8a7e6a',font:{family:'JetBrains Mono',size:9},stepSize:1},grid:{color:'rgba(255,255,255,0.03)'}}}}});
}

function renderFreeVsPaidChart() {
  const freeC = G.tickets.filter(t=>t.is_free).length;
  const paidC = G.tickets.filter(t=>!t.is_free).length;
  const ctx=_el('cFreeVsPaid'); if(!ctx) return;
  if(G.charts.fvp) G.charts.fvp.destroy();
  G.charts.fvp=new Chart(ctx,{type:'doughnut',data:{
    labels:['Free','Paid'],
    datasets:[{data:[freeC,paidC],backgroundColor:['rgba(61,214,140,0.7)','rgba(212,168,67,0.7)'],borderColor:'#09080f',borderWidth:2}]
  },options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#8a7e6a',font:{family:'JetBrains Mono',size:11}}}}}});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TICKETS TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTixTable() {
  let list = G.tickets;
  if (G.filter==='free')    list=list.filter(t=>t.is_free);
  else if(G.filter!=='all') list=list.filter(t=>t.status===G.filter);
  if (G.search) {
    const q=G.search.toLowerCase();
    list=list.filter(t=>t.ticket_id?.toLowerCase().includes(q)||t.user_name?.toLowerCase().includes(q)||t.email?.toLowerCase().includes(q)||t.utr?.includes(q));
  }
  G.filtered=list;

  const el=_el('tixBody');
  if(!list.length){
    el.innerHTML='<tr><td colspan="9"><div class="empty"><div class="empty-ico">ğŸŸ</div><div class="empty-txt">No tickets found</div></div></td></tr>';
    return;
  }
  el.innerHTML=list.map(tk=>`
    <tr id="tr-${tk.id}">
      <td><input type="checkbox" class="cb row-cb" data-id="${tk.id}" onchange="toggleSel('${tk.id}',this.checked)"></td>
      <td class="td-id">${tk.ticket_id}</td>
      <td><div class="td-name">${tk.user_name}</div><div class="td-email">${tk.email}</div></td>
      <td style="text-align:center">${tk.quantity}</td>
      <td class="td-amt ${tk.is_free?'free':''}">${tk.is_free?'FREE âœ¨':'â‚¹'+tk.amount}</td>
      <td>${tk.is_free?'<span class="sbadge sb-free"><div class="sd"></div>Free</span>':'<span style="font-family:JetBrains Mono,monospace;font-size:0.65rem;color:var(--g2)">Paid</span>'}</td>
      <td>${makeBadge(tk.status)}</td>
      <td class="td-date">${fmtDate(tk.created_at)}</td>
      <td><div class="acts">
        <button class="act act-app" onclick="updStatus('${tk.id}','approved')">âœ…</button>
        <button class="act act-rev" onclick="updStatus('${tk.id}','review')">ğŸ”</button>
        <button class="act act-rej" onclick="updStatus('${tk.id}','rejected')">âŒ</button>
        ${tk.screenshot_url?`<button class="act act-ss" onclick="viewSS('${tk.screenshot_url}')">ğŸ“¸</button>`:''}
        <button class="act act-del" onclick="delTix('${tk.id}')">ğŸ—‘</button>
      </div></td>
    </tr>`).join('');
}

function makeBadge(s) {
  const m={pending:['sb-pending','â³ Pending'],review:['sb-review','ğŸ” Review'],approved:['sb-approved','âœ… Approved'],rejected:['sb-rejected','âŒ Rejected']};
  const[c,l]=m[s]||m.pending;
  return `<div class="sbadge ${c}"><div class="sd"></div>${l}</div>`;
}

function setFilter(f,btn) {
  G.filter=f;
  $$('.fbar-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderTixTable();
}
function filterTix() { G.search=_v('searchIn'); renderTixTable(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATUS UPDATES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function updStatus(id, status) {
  try {
    await DB.patch('tickets',`id=eq.${id}`,{status});
    const i=G.tickets.findIndex(t=>t.id===id);
    if(i>=0) G.tickets[i].status=status;
    renderDash(); renderTixTable(); updatePendBadge();
    toast(`Ticket ${status} âœ“`,'ok');
  } catch(e) { toast('Update failed','err'); }
}

async function delTix(id) {
  if(!confirm('Delete this ticket? This cannot be undone.')) return;
  try {
    await DB.del('tickets',`id=eq.${id}`);
    G.tickets=G.tickets.filter(t=>t.id!==id);
    renderDash(); renderTixTable(); updatePendBadge();
    toast('Ticket deleted','err');
  } catch(e) { toast('Delete failed','err'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BULK ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSel(id,checked) { if(checked) G.selected.add(id); else G.selected.delete(id); updBulkBar(); }
function toggleSelAll(cb) {
  G.filtered.forEach(t=>{ if(cb.checked)G.selected.add(t.id);else G.selected.delete(t.id); const el=document.querySelector(`.row-cb[data-id="${t.id}"]`); if(el)el.checked=cb.checked; });
  updBulkBar();
}
function updBulkBar() {
  const n=G.selected.size;
  _el('bulkBar').style.display=n?'flex':'none';
  _t('bulkCnt',`${n} ticket${n>1?'s':''} selected`);
}
function clearSel() { G.selected.clear(); $$('.row-cb').forEach(cb=>cb.checked=false); if(_el('selAll'))_el('selAll').checked=false; updBulkBar(); }
async function bulkDo(action) {
  if(!G.selected.size) return;
  if(!confirm(`${action==='delete'?'Delete':'Update'} ${G.selected.size} ticket(s)?`)) return;
  let done=0;
  for(const id of G.selected) {
    try {
      if(action==='delete') await DB.del('tickets',`id=eq.${id}`);
      else await DB.patch('tickets',`id=eq.${id}`,{status:action});
      done++;
    } catch(e){}
  }
  clearSel(); await loadAll();
  toast(`${done} tickets updated âœ“`,'ok');
}

function updatePendBadge() {
  const n=G.tickets.filter(t=>t.status==='pending').length;
  const el=_el('pendBadge');
  el.textContent=n; el.style.display=n?'inline':'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCREENSHOT MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function viewSS(url) { _el('ssImg').src=url; _el('ssModal').classList.add('open'); }
function closeSS()   { _el('ssModal').classList.remove('open'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ANALYTICS PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAnalytics() {
  const t=G.tickets, c=G.cfg;
  const revenue      = t.filter(x=>x.status==='approved'&&!x.is_free).reduce((s,x)=>s+(+x.amount||0),0);
  const freeApproved = t.filter(x=>x.status==='approved'&&x.is_free).length;
  const paidApproved = t.filter(x=>x.status==='approved'&&!x.is_free).length;
  const remaining    = Math.max(0,(c.total_tickets||200)-(c.tickets_sold||0));

  _el('analyticsStats').innerHTML=`
    <div class="sc sc-blue"><div class="sc-icon">ğŸ’°</div><div class="sc-lbl">Total Revenue</div><div class="sc-val">â‚¹${revenue.toLocaleString('en-IN')}</div></div>
    <div class="sc sc-green"><div class="sc-icon">âœ¨</div><div class="sc-lbl">Free Approved</div><div class="sc-val">${freeApproved}</div></div>
    <div class="sc sc-gold"><div class="sc-icon">ğŸ«</div><div class="sc-lbl">Paid Approved</div><div class="sc-val">${paidApproved}</div></div>
    <div class="sc sc-purple"><div class="sc-icon">ğŸ“Š</div><div class="sc-lbl">Seats Remaining</div><div class="sc-val">${remaining}</div></div>
    <div class="sc sc-yellow"><div class="sc-icon">ğŸ“§</div><div class="sc-lbl">Unique Emails</div><div class="sc-val">${new Set(t.map(x=>x.email)).size}</div></div>
    <div class="sc sc-red"><div class="sc-icon">ğŸ”¢</div><div class="sc-lbl">Avg Order</div><div class="sc-val">â‚¹${t.length?Math.round(t.reduce((s,x)=>s+(+x.amount||0),0)/t.length):0}</div></div>
  `;

  // Revenue 14 days
  const days=Array.from({length:14},(_,i)=>{const d=new Date();d.setDate(d.getDate()-i);return d.toISOString().slice(0,10);}).reverse();
  const revDay=days.map(day=>t.filter(x=>x.created_at?.startsWith(day)&&x.status==='approved'&&!x.is_free).reduce((s,x)=>s+(+x.amount||0),0));
  const rCtx=_el('cRevenue'); if(rCtx){
    if(G.charts.rev) G.charts.rev.destroy();
    G.charts.rev=new Chart(rCtx,{type:'line',data:{
      labels:days.map(d=>new Date(d).toLocaleDateString('en-IN',{month:'short',day:'numeric'})),
      datasets:[{label:'Revenue (â‚¹)',data:revDay,borderColor:'rgba(212,168,67,0.8)',backgroundColor:'rgba(212,168,67,0.06)',borderWidth:2,pointBackgroundColor:'rgba(212,168,67,0.8)',tension:0.4,fill:true}]
    },options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#8a7e6a',font:{family:'JetBrains Mono',size:10}}}},scales:{x:{ticks:{color:'#8a7e6a',font:{family:'JetBrains Mono',size:9}},grid:{color:'rgba(255,255,255,0.03)'}},y:{ticks:{color:'#8a7e6a',font:{family:'JetBrains Mono',size:9}},grid:{color:'rgba(255,255,255,0.03)'}}}}});
  }

  // Free vs Paid pie
  const fCtx=_el('cTypeSplit'); if(fCtx){
    if(G.charts.split) G.charts.split.destroy();
    G.charts.split=new Chart(fCtx,{type:'pie',data:{
      labels:['Free Tickets','Paid Tickets'],
      datasets:[{data:[t.filter(x=>x.is_free).length,t.filter(x=>!x.is_free).length],backgroundColor:['rgba(61,214,140,0.7)','rgba(212,168,67,0.7)'],borderColor:'#09080f',borderWidth:2}]
    },options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#8a7e6a',font:{family:'JetBrains Mono',size:11}}}}}});
  }

  // Hourly
  const hours=Array.from({length:24},(_,i)=>i);
  const hCounts=hours.map(h=>t.filter(x=>new Date(x.created_at).getHours()===h).length);
  const hCtx=_el('cHourly'); if(hCtx){
    if(G.charts.hourly) G.charts.hourly.destroy();
    G.charts.hourly=new Chart(hCtx,{type:'bar',data:{
      labels:hours.map(h=>`${h}h`),
      datasets:[{label:'Bookings',data:hCounts,backgroundColor:'rgba(96,165,250,0.45)',borderColor:'rgba(96,165,250,0.7)',borderRadius:4,borderWidth:1}]
    },options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#8a7e6a',font:{family:'JetBrains Mono',size:8}},grid:{color:'rgba(255,255,255,0.03)'}},y:{ticks:{color:'#8a7e6a',font:{family:'JetBrains Mono',size:9},stepSize:1},grid:{color:'rgba(255,255,255,0.03)'}}}}});
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadSettingsForm() {
  const c=G.cfg;
  _sv('cfg-name', c.event_name||'');
  _sv('cfg-venue', c.venue||'');
  _sv('cfg-date', c.event_date||'');
  _sv('cfg-price', c.ticket_price||'');
  _sv('cfg-upi', c.upi_id||'');
  _sv('cfg-total', c.total_tickets||'');
  _sv('cfg-free', c.free_tickets||'');
  _sv('cfg-free-used', c.free_used||0);
  _sv('cfg-sold', c.tickets_sold||0);
  _el('tog-booking').checked = c.booking_enabled!==false;
  updateAvailWidget();
}

function updateAvailWidget() {
  const c=G.cfg;
  const remaining  = Math.max(0,(c.total_tickets||200)-(c.tickets_sold||0));
  const freeLeft   = Math.max(0,(c.free_tickets||50)-(c.free_used||0));
  const soldPct    = Math.min(100,Math.round(((c.tickets_sold||0)/(c.total_tickets||200))*100));
  const freePct    = Math.min(100,Math.round(((c.free_used||0)/Math.max(1,c.free_tickets||50))*100));
  _t('av-total',c.total_tickets||'â€”');
  _t('av-sold',c.tickets_sold||0);
  _t('av-free',c.free_tickets||'â€”');
  _t('av-freeUsed',c.free_used||0);
  _t('av-remaining',remaining);
  _t('av-freeLeft',freeLeft);
  _el('av-soldBar').style.width=soldPct+'%';
  _el('av-freeBar').style.width=freePct+'%';
  _el('av-remaining').style.color=remaining>0?'var(--grn)':'var(--red)';
  _el('av-freeLeft').style.color=freeLeft>0?'var(--grn)':'var(--muted)';
}

async function saveEventCfg() {
  const body={event_name:_v('cfg-name'),venue:_v('cfg-venue'),event_date:_v('cfg-date'),ticket_price:+_v('cfg-price')||100,upi_id:_v('cfg-upi')};
  try { await DB.patch('settings','id=eq.1',body); Object.assign(G.cfg,body); toast('Event config saved âœ“','ok'); }
  catch(e) { toast('Save failed: '+e.message,'err'); }
}
async function saveLimits() {
  const body={total_tickets:+_v('cfg-total')||200,free_tickets:+_v('cfg-free')||50};
  try { await DB.patch('settings','id=eq.1',body); Object.assign(G.cfg,body); updateAvailWidget(); toast('Limits saved âœ“','ok'); }
  catch(e) { toast('Save failed: '+e.message,'err'); }
}
async function saveToggles() {
  const body={booking_enabled:_el('tog-booking').checked};
  try { await DB.patch('settings','id=eq.1',body); Object.assign(G.cfg,body); toast('Controls saved âœ“','ok'); }
  catch(e) { toast('Save failed','err'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DANGER ZONE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function dangerOp(op) {
  if(op==='export-csv') { exportCSV(); return; }
  const msgs={'reset-free':'Reset free ticket counter to 0?','reset-sold':'Reset sold counter to 0?','clear-pending':'Delete ALL pending tickets?','clear-rejected':'Delete ALL rejected tickets?','clear-all':'DELETE ALL TICKETS? This cannot be undone!'};
  if(!confirm(msgs[op])) return;
  try {
    if(op==='reset-free')     await DB.patch('settings','id=eq.1',{free_used:0});
    else if(op==='reset-sold')await DB.patch('settings','id=eq.1',{tickets_sold:0});
    else if(op==='clear-pending')  await DB.del('tickets','status=eq.pending');
    else if(op==='clear-rejected') await DB.del('tickets','status=eq.rejected');
    else if(op==='clear-all')      await DB.del('tickets','id=gt.00000000-0000-0000-0000-000000000000');
    await loadAll(); loadSettingsForm();
    toast('Done âœ“','ok');
  } catch(e) { toast('Operation failed: '+e.message,'err'); }
}

function exportCSV() {
  const t=G.tickets; if(!t.length){toast('No tickets','err');return;}
  const hdr='Ticket ID,Name,Email,Phone,Movie,Qty,Amount,Free,Status,UTR,Date';
  const rows=t.map(r=>[r.ticket_id,r.user_name,r.email,r.phone||'',r.movie_name||'',r.quantity,r.amount,r.is_free?'Yes':'No',r.status,r.utr||'',r.created_at].map(v=>`"${String(v||'').replace(/"/g,'""')}"`).join(','));
  const csv=[hdr,...rows].join('\n');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  a.download='rtd-tickets-'+new Date().toISOString().slice(0,10)+'.csv';
  a.click(); toast('CSV exported âœ“','ok');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg,type='') {
  const el=document.createElement('div');
  el.className='toast'+(type?' '+type:'');
  const ic={ok:'âœ“ ',err:'âœ• ',inf:'â„¹ '};
  el.textContent=(ic[type]||'')+msg;
  _el('toasts').appendChild(el);
  setTimeout(()=>{el.classList.add('bye');setTimeout(()=>el.remove(),250);},3200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmtDate(iso) { try{return new Date(iso).toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'});}catch(e){return iso||'â€”';} }
function bumpVal(id,n) { const el=_el(id); if(!el)return; if(el.textContent===String(n))return; el.textContent=n; el.classList.add('bump'); setTimeout(()=>el.classList.remove('bump'),400); }
const _el = id=>document.getElementById(id);
const _t  = (id,v)=>{ const e=_el(id); if(e) e.textContent=v; };
const _v  = id=>(_el(id)||{}).value||'';
const _sv = (id,v)=>{ const e=_el(id); if(e) e.value=v; };
const $$  = s=>document.querySelectorAll(s);

document.addEventListener('keydown',e=>{if(e.key==='Escape')closeSS();});
</script>
</body>
</html>
