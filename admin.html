<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>RTD Admin ‚Äî Reel to Deal</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#060405;--sur:#0d0a0e;--s2:#141018;--s3:#1c1624;
  --gold:#d4a853;--gold2:#f0c46a;--goldg:rgba(212,168,83,.12);--goldg2:rgba(212,168,83,.06);
  --text:#f2ead8;--muted:#6b5f4e;--border:rgba(212,168,83,.15);--border2:rgba(212,168,83,.08);
  --green:#3ec47a;--red:#e05555;--yellow:#e8b840;--blue:#4c82ff;
  --r8:8px;--r12:12px;--r16:16px;
}
*{margin:0;padding:0;box-sizing:border-box;}
html{-webkit-tap-highlight-color:transparent;}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;background:radial-gradient(ellipse 60% 40% at 20% 0%,rgba(212,168,83,.04) 0%,transparent 70%);}
@keyframes fup{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes fi{from{opacity:0}to{opacity:1}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
@keyframes pulse{0%,100%{opacity:.2}50%{opacity:1}}
@keyframes bump{0%{transform:scale(1)}50%{transform:scale(1.12)}100%{transform:scale(1)}}
@keyframes scan{0%,100%{opacity:.3;transform:scaleX(.4)}50%{opacity:1;transform:scaleX(1)}}
@keyframes rowIn{from{opacity:0;transform:translateX(-6px)}to{opacity:1;transform:translateX(0)}}

/* LOAD */
#ls{position:fixed;inset:0;z-index:10000;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;transition:opacity .5s,visibility .5s;}
#ls.out{opacity:0;visibility:hidden;}
.ls-logo{font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:8px;color:var(--gold);text-shadow:0 0 38px rgba(212,168,83,.4);animation:lsIn .8s cubic-bezier(.16,1,.3,1) both;}
@keyframes lsIn{from{opacity:0;letter-spacing:22px}to{opacity:1;letter-spacing:8px}}
.ls-bar{width:130px;height:1.5px;background:rgba(212,168,83,.12);border-radius:2px;overflow:hidden;}
.ls-fill{height:100%;background:var(--gold);animation:lsFill 1s cubic-bezier(.4,0,.2,1) .2s both;}
@keyframes lsFill{from{width:0}to{width:100%}}
.ls-sub{font-family:'Space Mono',monospace;font-size:.5rem;letter-spacing:4px;color:var(--muted);animation:fup .5s .45s both;}

/* LOGIN */
#loginScreen{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px;position:relative;z-index:1;}
.login-card{background:var(--sur);border:1px solid var(--border);border-radius:20px;padding:34px;width:100%;max-width:370px;text-align:center;position:relative;overflow:hidden;}
.login-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1.5px;background:linear-gradient(90deg,transparent,var(--gold),transparent);animation:scan 4s ease-in-out infinite;}
.login-logo{font-family:'Bebas Neue',sans-serif;font-size:2.4rem;letter-spacing:6px;color:var(--gold);text-shadow:0 0 22px rgba(212,168,83,.28);}
.login-sub{font-family:'Space Mono',monospace;font-size:.54rem;letter-spacing:3px;color:var(--muted);margin-bottom:24px;margin-top:4px;}
.pw-wrap{position:relative;margin-bottom:12px;}
.pw-wrap input{width:100%;background:var(--s2);border:1px solid var(--border2);border-radius:10px;padding:12px 44px 12px 14px;color:var(--text);font-family:'Space Mono',monospace;font-size:.85rem;letter-spacing:3px;outline:none;transition:border-color .2s,box-shadow .2s;}
.pw-wrap input:focus{border-color:var(--gold);box-shadow:0 0 0 3px var(--goldg);}
.pw-wrap input.error{border-color:var(--red);animation:shake .32s ease;}
.pw-eye{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--muted);cursor:pointer;font-size:.95rem;padding:4px;transition:color .2s;}
.pw-eye:hover{color:var(--gold);}
.btn-login{width:100%;padding:12px;background:var(--gold);color:#0a0806;border:none;border-radius:10px;font-family:'Space Mono',monospace;font-size:.78rem;letter-spacing:3px;text-transform:uppercase;cursor:pointer;transition:all .22s;font-weight:700;}
.btn-login:hover{transform:translateY(-1px);box-shadow:0 8px 22px rgba(212,168,83,.28);}
.login-err{display:none;color:var(--red);font-family:'Space Mono',monospace;font-size:.67rem;margin-top:9px;letter-spacing:1px;}
.login-err.show{display:block;animation:fup .2s ease;}

/* APP */
#app{display:none;}
#app.vis{display:block;animation:fi .3s ease;}

/* HEADER */
.hdr{background:rgba(6,4,5,.96);border-bottom:1px solid var(--border2);padding:12px 22px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;position:sticky;top:0;z-index:100;backdrop-filter:blur(16px);}
.hdr-brand{display:flex;align-items:center;gap:12px;}
.hdr-logo{font-family:'Bebas Neue',sans-serif;font-size:1.55rem;letter-spacing:4px;color:var(--gold);}
.hdr-divider{width:1px;height:22px;background:var(--border2);}
.hdr-sub{font-family:'Space Mono',monospace;font-size:.52rem;letter-spacing:1.5px;color:var(--muted);}
.hdr-right{display:flex;align-items:center;gap:7px;flex-wrap:wrap;}
.sync-pill{display:inline-flex;align-items:center;gap:5px;background:var(--goldg2);border:1px solid var(--border2);border-radius:100px;padding:5px 11px;font-family:'Space Mono',monospace;font-size:.54rem;letter-spacing:1px;transition:all .3s;color:var(--muted);}
.sync-pill.ok{color:var(--green);background:rgba(62,196,122,.07);border-color:rgba(62,196,122,.22);}
.sync-pill.err{color:var(--red);border-color:rgba(224,85,85,.22);}
.sdot{width:5px;height:5px;border-radius:50%;background:currentColor;flex-shrink:0;animation:pulse 2s ease-in-out infinite;}
.hdr-btn{background:transparent;border:1px solid var(--border2);color:var(--muted);padding:6px 12px;border-radius:7px;font-family:'Space Mono',monospace;font-size:.58rem;letter-spacing:1px;cursor:pointer;transition:all .2s;white-space:nowrap;}
.hdr-btn:hover{border-color:var(--gold);color:var(--gold);}
.hdr-btn.danger:hover{border-color:var(--red);color:var(--red);}

/* STATS */
.stats-row{display:grid;grid-template-columns:repeat(6,1fr);gap:9px;padding:16px 22px;}
.stat-card{background:var(--sur);border:1px solid var(--border2);border-radius:12px;padding:14px 12px;text-align:center;transition:border-color .25s,transform .2s;position:relative;overflow:hidden;}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;opacity:.35;}
.stat-card.gold::before{background:var(--gold);}
.stat-card.green::before{background:var(--green);}
.stat-card.yellow::before{background:var(--yellow);}
.stat-card.red::before{background:var(--red);}
.stat-card.blue::before{background:var(--blue);}
.stat-card.purple::before{background:#b06be0;}
.stat-card:hover{border-color:rgba(212,168,83,.25);transform:translateY(-2px);}
.stat-val{font-family:'Bebas Neue',sans-serif;font-size:1.9rem;line-height:1;transition:all .2s;}
.stat-val.pop{animation:bump .35s cubic-bezier(.34,1.56,.64,1);}
.stat-lbl{font-family:'Space Mono',monospace;font-size:.52rem;letter-spacing:1.5px;color:var(--muted);text-transform:uppercase;margin-top:3px;}

/* ANALYTICS BAR */
.analytics-bar{padding:0 22px 14px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
.rev-pill{background:rgba(62,196,122,.07);border:1px solid rgba(62,196,122,.18);border-radius:8px;padding:8px 14px;font-family:'Space Mono',monospace;font-size:.68rem;color:var(--green);}
.rev-pill strong{font-size:1.05rem;display:block;}
.rate-pill{background:var(--goldg2);border:1px solid var(--border2);border-radius:8px;padding:8px 14px;font-family:'Space Mono',monospace;font-size:.68rem;color:var(--gold);}
.rate-pill strong{font-size:1.05rem;display:block;}
.prog-wrap{flex:1;min-width:180px;background:var(--s2);border:1px solid var(--border2);border-radius:8px;padding:8px 12px;}
.prog-label{font-family:'Space Mono',monospace;font-size:.56rem;color:var(--muted);margin-bottom:5px;display:flex;justify-content:space-between;}
.prog-bar{height:5px;background:var(--s3);border-radius:100px;overflow:hidden;}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--gold),var(--green));border-radius:100px;transition:width .6s cubic-bezier(.4,0,.2,1);}

/* TABS */
.tabs{display:flex;gap:4px;padding:0 22px;border-bottom:1px solid var(--border2);overflow-x:auto;}
.tab{background:transparent;border:1px solid transparent;color:var(--muted);padding:8px 16px;border-radius:8px 8px 0 0;font-family:'Space Mono',monospace;font-size:.58rem;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:all .2s;border-bottom:none;margin-bottom:-1px;white-space:nowrap;flex-shrink:0;}
.tab.active{background:var(--sur);border-color:var(--border2);border-bottom-color:var(--sur);color:var(--gold);}
.tab:hover:not(.active){color:var(--gold);}
.tab-panel{display:none;}
.tab-panel.active{display:block;animation:fi .2s ease;}

/* CONTROLS */
.controls{display:flex;gap:7px;align-items:center;padding:13px 22px;flex-wrap:wrap;}
.srch{flex:1;min-width:160px;background:var(--sur);border:1px solid var(--border2);border-radius:8px;padding:8px 13px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:.86rem;outline:none;transition:border-color .2s;}
.srch:focus{border-color:var(--gold);box-shadow:0 0 0 3px var(--goldg);}
.sel{background:var(--sur);border:1px solid var(--border2);border-radius:8px;padding:8px 11px;color:var(--text);font-family:'Space Mono',monospace;font-size:.63rem;cursor:pointer;outline:none;transition:border-color .2s;}
.sel:focus{border-color:var(--gold);}
.ctrl-btn{padding:8px 13px;border-radius:8px;font-family:'Space Mono',monospace;font-size:.6rem;letter-spacing:1px;cursor:pointer;border:1px solid;transition:all .2s;white-space:nowrap;}
.cb-refresh{border-color:var(--border2);color:var(--muted);background:transparent;}
.cb-refresh:hover{border-color:var(--gold);color:var(--gold);}
.cb-approve{border-color:rgba(62,196,122,.35);color:var(--green);background:rgba(62,196,122,.07);}
.cb-approve:hover{background:rgba(62,196,122,.18);}
.cb-export{border-color:var(--border2);color:var(--muted);background:transparent;}
.cb-export:hover{border-color:var(--blue);color:var(--blue);}
.result-count{padding:0 22px 6px;font-family:'Space Mono',monospace;font-size:.58rem;color:var(--muted);}

/* TABLE */
.tbl-wrap{padding:0 22px 40px;overflow-x:auto;}
table{width:100%;border-collapse:collapse;font-size:.82rem;min-width:900px;}
thead tr{border-bottom:1px solid var(--border2);}
th{padding:10px 8px;text-align:left;font-family:'Space Mono',monospace;font-size:.52rem;letter-spacing:2px;color:var(--muted);text-transform:uppercase;white-space:nowrap;cursor:pointer;user-select:none;}
th:hover{color:var(--gold);}
th.sort-asc::after{content:' ‚ñ≤';font-size:.5rem;}
th.sort-desc::after{content:' ‚ñº';font-size:.5rem;}
td{padding:11px 8px;border-bottom:1px solid rgba(255,255,255,.028);vertical-align:middle;}
tr:hover td{background:rgba(212,168,83,.025);}
tr.row-in{animation:rowIn .3s cubic-bezier(.16,1,.3,1) both;}
.bid{font-family:'Space Mono',monospace;font-size:.68rem;color:var(--gold);}
.name-cell strong{display:block;font-size:.86rem;}
.name-cell span{font-size:.66rem;color:var(--muted);}
.sbadge{display:inline-block;padding:3px 9px;border-radius:100px;font-size:.54rem;font-family:'Space Mono',monospace;letter-spacing:1.5px;text-transform:uppercase;font-weight:700;}
.sbadge.pending{background:rgba(232,184,64,.1);color:var(--yellow);border:1px solid rgba(232,184,64,.28);}
.sbadge.approved{background:rgba(62,196,122,.1);color:var(--green);border:1px solid rgba(62,196,122,.28);}
.sbadge.rejected{background:rgba(224,85,85,.1);color:var(--red);border:1px solid rgba(224,85,85,.28);}
.act-btns{display:flex;gap:4px;flex-wrap:wrap;}
.act-btn{padding:4px 8px;border-radius:6px;font-size:.55rem;font-family:'Space Mono',monospace;letter-spacing:1px;cursor:pointer;border:1px solid;transition:all .18s;text-transform:uppercase;}
.act-btn:hover{transform:translateY(-1px);}
.ap-btn{border-color:rgba(62,196,122,.35);color:var(--green);background:rgba(62,196,122,.06);}
.ap-btn:hover{background:rgba(62,196,122,.18);}
.rj-btn{border-color:rgba(224,85,85,.35);color:var(--red);background:rgba(224,85,85,.06);}
.rj-btn:hover{background:rgba(224,85,85,.18);}
.del-btn{border-color:rgba(224,85,85,.18);color:rgba(224,85,85,.4);background:transparent;}
.del-btn:hover{border-color:var(--red);color:var(--red);}
.ss-thumb{width:32px;height:32px;object-fit:cover;border-radius:5px;border:1px solid var(--border2);cursor:pointer;transition:all .2s;display:block;}
.ss-thumb:hover{transform:scale(1.15);border-color:var(--gold);}
.ocr-pair{font-family:'Space Mono',monospace;font-size:.56rem;line-height:1.9;}
.no-data{text-align:center;padding:50px 20px;color:var(--muted);font-family:'Space Mono',monospace;font-size:.72rem;letter-spacing:2px;}
.spn{width:14px;height:14px;border:2px solid rgba(255,255,255,.2);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite;display:inline-block;vertical-align:middle;margin-right:5px;}

/* SETTINGS */
.settings-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px;padding:16px 22px;}
.stg-card{background:var(--sur);border:1px solid var(--border2);border-radius:14px;padding:20px;position:relative;overflow:hidden;}
.stg-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--gold),transparent);opacity:.35;}
.stg-title{font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:3px;color:var(--gold);margin-bottom:14px;display:flex;align-items:center;gap:7px;}
.fg{margin-bottom:12px;}
.fg label{display:block;font-family:'Space Mono',monospace;font-size:.56rem;letter-spacing:2px;color:var(--muted);text-transform:uppercase;margin-bottom:5px;}
.fg input,.fg select,.fg textarea{width:100%;background:var(--s2);border:1px solid var(--border2);border-radius:8px;padding:9px 12px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:.86rem;outline:none;transition:border-color .2s,box-shadow .2s;}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--gold);box-shadow:0 0 0 3px var(--goldg);}
.fg textarea{resize:vertical;min-height:70px;font-size:.8rem;line-height:1.6;}
.toggle-row{display:flex;align-items:center;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--border2);}
.toggle-row:last-child{border:none;}
.toggle-lbl{font-family:'Space Mono',monospace;font-size:.65rem;color:var(--text);}
.toggle-sub{font-size:.58rem;color:var(--muted);margin-top:2px;}
.toggle{position:relative;width:38px;height:20px;flex-shrink:0;}
.toggle input{opacity:0;width:0;height:0;position:absolute;}
.toggle-track{position:absolute;inset:0;background:var(--s3);border-radius:20px;cursor:pointer;transition:background .28s;border:1px solid var(--border2);}
.toggle input:checked+.toggle-track{background:var(--green);}
.toggle-knob{position:absolute;top:3px;left:3px;width:12px;height:12px;background:#fff;border-radius:50%;transition:transform .28s cubic-bezier(.34,1.56,.64,1);pointer-events:none;box-shadow:0 1px 4px rgba(0,0,0,.4);}
.toggle input:checked~.toggle-knob{transform:translateX(18px);}
.stg-btn{width:100%;padding:10px;border-radius:8px;font-family:'Space Mono',monospace;font-size:.72rem;letter-spacing:2px;cursor:pointer;transition:all .2s;margin-top:4px;}
.btn-save{background:var(--gold);color:#0a0806;border:none;font-weight:700;}
.btn-save:hover{background:var(--gold2);transform:translateY(-1px);}
.btn-save:disabled{opacity:.4;cursor:not-allowed;transform:none;}
.btn-del-stg{background:rgba(224,85,85,.07);border:1px solid rgba(224,85,85,.25);color:var(--red);}
.btn-del-stg:hover{background:rgba(224,85,85,.16);}
.stg-msg{font-family:'Space Mono',monospace;font-size:.63rem;margin-top:8px;padding:7px 10px;border-radius:6px;display:none;}
.stg-msg.ok{background:rgba(62,196,122,.09);border:1px solid rgba(62,196,122,.28);color:var(--green);display:block;animation:fup .2s ease;}
.stg-msg.err{background:rgba(224,85,85,.09);border:1px solid rgba(224,85,85,.28);color:var(--red);display:block;animation:fup .2s ease;}

/* MOVIE CHANGER HIGHLIGHT */
.stg-card.movie-changer{border-color:rgba(212,168,83,.3);background:linear-gradient(135deg,var(--sur),rgba(20,16,8,.9));}
.stg-card.movie-changer::before{opacity:1;animation:scan 3s ease-in-out infinite;}
.movie-input-wrap{position:relative;}
.movie-input-wrap input{padding-right:80px;font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:2px;color:var(--gold);}
.movie-prev-lbl{position:absolute;right:8px;top:50%;transform:translateY(-50%);font-size:.48rem;color:var(--muted);font-family:'Space Mono',monospace;letter-spacing:1px;pointer-events:none;}

/* USERS / BOOKINGS panel extras */
.user-card{background:var(--sur);border:1px solid var(--border2);border-radius:12px;padding:14px 16px;display:flex;align-items:center;gap:14px;transition:border-color .2s;cursor:default;}
.user-card:hover{border-color:rgba(212,168,83,.22);}
.user-avatar{width:38px;height:38px;border-radius:50%;background:var(--goldg);border:1.5px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;}
.user-info strong{font-size:.88rem;display:block;}
.user-info span{font-family:'Space Mono',monospace;font-size:.58rem;color:var(--muted);}
.user-stats{margin-left:auto;text-align:right;}
.user-stats strong{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;color:var(--gold);}
.user-stats span{font-family:'Space Mono',monospace;font-size:.52rem;color:var(--muted);display:block;}
.users-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:9px;padding:14px 22px;}

/* IMAGE MODAL */
#imgModal{position:fixed;inset:0;z-index:8000;background:rgba(0,0,0,.92);display:none;align-items:center;justify-content:center;backdrop-filter:blur(14px);}
#imgModal.show{display:flex;animation:fi .2s ease;}
#imgModal img{max-width:90vw;max-height:90vh;border-radius:12px;border:1px solid var(--border2);}
#imgModal .close-btn{position:absolute;top:18px;right:18px;background:rgba(255,255,255,.08);border:1px solid var(--border2);color:var(--text);width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1.1rem;transition:all .2s;}
#imgModal .close-btn:hover{background:rgba(224,85,85,.2);color:var(--red);}

/* CONFIRM MODAL */
#confirmModal{position:fixed;inset:0;z-index:9000;display:none;align-items:center;justify-content:center;}
#confirmModal.show{display:flex;background:rgba(0,0,0,.88);backdrop-filter:blur(12px);animation:fi .2s ease;}
.confirm-box{background:var(--sur);border:1px solid var(--border);border-radius:16px;padding:22px;max-width:320px;width:90%;text-align:center;}
.confirm-title{font-family:'Bebas Neue',sans-serif;font-size:1.2rem;letter-spacing:3px;margin-bottom:8px;}
.confirm-msg{font-family:'Space Mono',monospace;font-size:.67rem;color:var(--muted);margin-bottom:18px;line-height:1.75;}
.confirm-btns{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.cbtn{padding:10px;border-radius:8px;font-family:'Space Mono',monospace;font-size:.68rem;letter-spacing:2px;cursor:pointer;transition:all .2s;border:1px solid;}
.cbtn-yes{background:var(--red);border-color:var(--red);color:#fff;}
.cbtn-yes:hover{opacity:.85;}
.cbtn-yes.gold{background:var(--gold);border-color:var(--gold);color:#0a0806;}
.cbtn-no{background:transparent;border-color:var(--border2);color:var(--muted);}
.cbtn-no:hover{border-color:var(--gold);color:var(--gold);}

/* TOAST */
.toast{position:fixed;bottom:20px;right:22px;background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:10px 16px;font-family:'Space Mono',monospace;font-size:.7rem;color:var(--text);z-index:20000;transform:translateY(80px);transition:transform .3s cubic-bezier(.34,1.56,.64,1);backdrop-filter:blur(10px);max-width:300px;}
.toast.show{transform:translateY(0);}
.toast.success{border-color:var(--green);color:var(--green);}
.toast.error{border-color:var(--red);color:var(--red);}
.toast.info{border-color:var(--gold);color:var(--gold);}
.toast.warn{border-color:var(--yellow);color:var(--yellow);}

@media(max-width:768px){
  .stats-row{grid-template-columns:repeat(3,1fr);}
  .settings-grid{grid-template-columns:1fr;}
  .hdr{padding:10px 14px;}.tbl-wrap{padding:0 14px 40px;}
  .controls,.stats-row,.analytics-bar,.tabs,.result-count,.users-grid{padding-left:14px;padding-right:14px;}
}
@media(max-width:480px){.stats-row{grid-template-columns:repeat(2,1fr);}}
</style>
</head>
<body>

<div id="ls">
  <div class="ls-logo">üé¨ REEL TO DEAL</div>
  <div class="ls-bar"><div class="ls-fill"></div></div>
  <div class="ls-sub">ADMIN PANEL ¬∑ LOADING</div>
</div>

<!-- LOGIN -->
<div id="loginScreen" style="display:none;">
  <div class="login-card">
    <div class="login-logo">üé¨ RTD</div>
    <div class="login-sub">Admin Access ¬∑ Reel to Deal</div>
    <div class="pw-wrap">
      <input type="password" id="pwInput" placeholder="Enter admin password" onkeydown="if(event.key==='Enter')doLogin()">
      <button class="pw-eye" onclick="togglePw()" id="eyeBtn">üëÅ</button>
    </div>
    <button class="btn-login" onclick="doLogin()">Unlock Panel</button>
    <div class="login-err" id="loginErr">‚ö† Incorrect password. Please try again.</div>
    <p style="font-family:'Space Mono',monospace;font-size:.52rem;color:var(--muted);margin-top:14px;letter-spacing:1px">This panel is for authorised event staff only.</p>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div class="hdr">
    <div class="hdr-brand">
      <div class="hdr-logo">üé¨ Reel to Deal</div>
      <div class="hdr-divider"></div>
      <div class="hdr-sub">ADMIN PANEL</div>
    </div>
    <div class="hdr-right">
      <div class="sync-pill" id="syncPill"><div class="sdot"></div><span id="syncTxt">Loading...</span></div>
      <button class="hdr-btn" onclick="loadAll()">‚Ü∫ Refresh</button>
      <button class="hdr-btn" onclick="exportCSV()">‚¨á CSV</button>
      <a href="index.html" style="text-decoration:none"><button class="hdr-btn">üéü Booking Page</button></a>
      <button class="hdr-btn danger" onclick="confirmLogout()">Logout</button>
    </div>
  </div>

  <!-- STATS -->
  <div class="stats-row" id="statsRow">
    <div class="stat-card gold"><div class="stat-val" id="stTotal" style="color:var(--gold)">‚Äî</div><div class="stat-lbl">Total</div></div>
    <div class="stat-card green"><div class="stat-val" id="stApproved" style="color:var(--green)">‚Äî</div><div class="stat-lbl">Approved</div></div>
    <div class="stat-card yellow"><div class="stat-val" id="stPending" style="color:var(--yellow)">‚Äî</div><div class="stat-lbl">Pending</div></div>
    <div class="stat-card red"><div class="stat-val" id="stRejected" style="color:var(--red)">‚Äî</div><div class="stat-lbl">Rejected</div></div>
    <div class="stat-card blue"><div class="stat-val" id="stTickets" style="color:var(--blue)">‚Äî</div><div class="stat-lbl">Tickets</div></div>
    <div class="stat-card purple"><div class="stat-val" id="stRevenue" style="color:#b06be0">‚Äî</div><div class="stat-lbl">Revenue</div></div>
  </div>

  <div class="analytics-bar">
    <div class="rev-pill"><span>Total Revenue</span><strong id="revPill">‚Çπ0</strong></div>
    <div class="rate-pill"><span>Approval Rate</span><strong id="ratePill">0%</strong></div>
    <div class="prog-wrap">
      <div class="prog-label"><span>Verified Bookings</span><span id="progLbl">0 / 0</span></div>
      <div class="prog-bar"><div class="prog-fill" id="progFill" style="width:0%"></div></div>
    </div>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <button class="tab active" onclick="switchTab('bookings',this)">üìã Bookings</button>
    <button class="tab" onclick="switchTab('users',this)">üë• Users</button>
    <button class="tab" onclick="switchTab('settings',this)">‚öô Settings</button>
  </div>

  <!-- BOOKINGS PANEL -->
  <div class="tab-panel active" id="tab-bookings">
    <div class="controls">
      <input class="srch" id="srchInput" placeholder="üîç Search name, email, phone, booking ID, UTR..." oninput="filterTable()">
      <select class="sel" id="statusFilter" onchange="filterTable()">
        <option value="">All Status</option>
        <option value="pending">Pending</option>
        <option value="approved">Approved</option>
        <option value="rejected">Rejected</option>
      </select>
      <select class="sel" id="sortSel" onchange="filterTable()">
        <option value="newest">Newest First</option>
        <option value="oldest">Oldest First</option>
        <option value="amount_high">Amount ‚Üì</option>
        <option value="name_az">Name A-Z</option>
      </select>
      <button class="ctrl-btn cb-refresh" onclick="loadAll()">‚Ü∫ Refresh</button>
      <button class="ctrl-btn cb-approve" onclick="approveAllPending()">‚úì Approve All Pending</button>
      <button class="ctrl-btn cb-export" onclick="exportCSV()">‚¨á Export CSV</button>
    </div>
    <div class="result-count" id="resultCount"></div>
    <div class="tbl-wrap">
      <table>
        <thead>
          <tr>
            <th onclick="sortBy('booking_id')">Booking ID</th>
            <th onclick="sortBy('name')">Name / Contact</th>
            <th onclick="sortBy('ticket_qty')">Qty</th>
            <th onclick="sortBy('amount')">Amount</th>
            <th>UTR</th>
            <th>OCR</th>
            <th>Screenshot</th>
            <th onclick="sortBy('status')">Status</th>
            <th onclick="sortBy('created_at')">Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tbl"></tbody>
      </table>
      <div id="noDataMsg" class="no-data" style="display:none">No bookings found</div>
    </div>
  </div>

  <!-- USERS PANEL -->
  <div class="tab-panel" id="tab-users">
    <div class="controls">
      <input class="srch" id="userSearch" placeholder="üîç Search users..." oninput="renderUsers()">
      <select class="sel" id="userSort" onchange="renderUsers()">
        <option value="recent">Most Recent</option>
        <option value="most_tickets">Most Tickets</option>
        <option value="highest_spend">Highest Spend</option>
        <option value="name_az">Name A-Z</option>
      </select>
    </div>
    <div class="result-count" id="userCount"></div>
    <div class="users-grid" id="usersGrid"></div>
  </div>

  <!-- SETTINGS PANEL -->
  <div class="tab-panel" id="tab-settings">
    <div class="settings-grid">

      <!-- MOVIE NAME CHANGER (HIGHLIGHTED) -->
      <div class="stg-card movie-changer" style="grid-column:1/-1">
        <div class="stg-title">üé¨ Movie Name & Poster</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div class="fg">
            <label>Movie / Event Name</label>
            <div class="movie-input-wrap">
              <input type="text" id="stgMovieName" placeholder="e.g. The Dark Knight" oninput="previewMovieName()">
              <span class="movie-prev-lbl" id="moviePrevLbl">PREVIEW</span>
            </div>
          </div>
          <div class="fg">
            <label>Movie Poster URL (optional)</label>
            <input type="text" id="stgPosterUrl" placeholder="https://... or leave empty">
          </div>
        </div>
        <div style="background:var(--s2);border:1px solid var(--border2);border-radius:8px;padding:10px 12px;margin-bottom:12px;font-family:'Space Mono',monospace;font-size:.65rem;color:var(--muted);line-height:1.8">
          üí° Changing the movie name updates the booking page live. Users will see the new name immediately after save.
          A valid poster URL will show the movie poster in the hero section and on tickets.
        </div>
        <button class="stg-btn btn-save" onclick="saveMovieName()">üé¨ Save Movie Name & Poster</button>
        <div class="stg-msg" id="movieMsg"></div>
      </div>

      <!-- EVENT DETAILS -->
      <div class="stg-card">
        <div class="stg-title">üìÖ Event Details</div>
        <div class="fg"><label>Event Date (ISO format)</label><input type="datetime-local" id="stgEventDate"></div>
        <div class="fg"><label>Display Date / Time</label><input type="text" id="stgEventDateDisplay" placeholder="e.g. FEB 17, 2025 ¬∑ 1:00 PM"></div>
        <div class="fg"><label>Venue</label><input type="text" id="stgVenue" placeholder="e.g. MBA Auditorium"></div>
        <div class="fg"><label>Notice / Announcement (shown on booking page)</label><textarea id="stgDescription" placeholder="Leave blank for no notice..."></textarea></div>
        <button class="stg-btn btn-save" onclick="saveSettings('event')">Save Event Details</button>
        <div class="stg-msg" id="eventMsg"></div>
      </div>

      <!-- PRICING -->
      <div class="stg-card">
        <div class="stg-title">üí∞ Pricing & Limits</div>
        <div class="fg"><label>Ticket Price (‚Çπ)</label><input type="number" id="stgPrice" placeholder="100" min="1"></div>
        <div class="fg"><label>Max Tickets Per Booking</label><input type="number" id="stgMaxTix" placeholder="5" min="1" max="20"></div>
        <button class="stg-btn btn-save" onclick="saveSettings('pricing')">Save Pricing</button>
        <div class="stg-msg" id="pricingMsg"></div>
      </div>

      <!-- UPI SETTINGS -->
      <div class="stg-card">
        <div class="stg-title">üì≤ UPI Payment Details</div>
        <div class="fg"><label>UPI ID</label><input type="text" id="stgUpi" placeholder="yourname@bank"></div>
        <div class="fg"><label>Payee Display Name</label><input type="text" id="stgPayee" placeholder="REEL TO DEAL"></div>
        <div style="background:rgba(212,168,83,.06);border:1px solid var(--border2);border-radius:8px;padding:10px;font-family:'Space Mono',monospace;font-size:.6rem;color:var(--muted);margin-bottom:10px;line-height:1.75">
          ‚ö† Changing UPI ID will affect all new bookings. Existing bookings are unaffected.
        </div>
        <button class="stg-btn btn-save" onclick="saveSettings('upi')">Save UPI Details</button>
        <div class="stg-msg" id="upiMsg"></div>
      </div>

      <!-- AUTOMATION -->
      <div class="stg-card">
        <div class="stg-title">ü§ñ Automation & Verification</div>
        <div class="toggle-row">
          <div>
            <div class="toggle-lbl">Auto-Approve</div>
            <div class="toggle-sub">Auto-approve when OCR fully verifies amount & UPI</div>
          </div>
          <label class="toggle"><input type="checkbox" id="stgAutoApprove"><div class="toggle-track"></div><div class="toggle-knob"></div></label>
        </div>
        <div class="toggle-row">
          <div>
            <div class="toggle-lbl">Require Screenshot</div>
            <div class="toggle-sub">Users must upload payment screenshot</div>
          </div>
          <label class="toggle"><input type="checkbox" id="stgRequireSS" checked><div class="toggle-track"></div><div class="toggle-knob"></div></label>
        </div>
        <button class="stg-btn btn-save" onclick="saveSettings('automation')" style="margin-top:14px">Save Automation Settings</button>
        <div class="stg-msg" id="autoMsg"></div>
      </div>

      <!-- DANGER ZONE -->
      <div class="stg-card" style="border-color:rgba(224,85,85,.2)">
        <div class="stg-title" style="color:var(--red)">‚ö† Danger Zone</div>
        <p style="font-family:'Space Mono',monospace;font-size:.63rem;color:var(--muted);margin-bottom:14px;line-height:1.75">These actions are irreversible. Proceed with caution.</p>
        <button class="stg-btn btn-del-stg" onclick="confirmDeleteAll()">üóë Delete ALL Bookings</button>
        <div class="stg-msg" id="dangerMsg"></div>
      </div>

    </div>
  </div>

</div>

<!-- IMAGE MODAL -->
<div id="imgModal" onclick="closeImgModal()">
  <button class="close-btn" onclick="closeImgModal()">‚úï</button>
  <img id="modalImg" src="" alt="Screenshot">
</div>

<!-- CONFIRM MODAL -->
<div id="confirmModal">
  <div class="confirm-box">
    <div class="confirm-title" id="confirmTitle">Confirm Action</div>
    <div class="confirm-msg" id="confirmMsg">Are you sure?</div>
    <div class="confirm-btns">
      <button class="cbtn cbtn-yes" id="confirmYes" onclick="confirmExec()">Confirm</button>
      <button class="cbtn cbtn-no" onclick="closeConfirm()">Cancel</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
'use strict';
const SB_URL='https://yhrfpcwehtqsppoifhog.supabase.co';
const SB_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlocmZwY3dlaHRxc3Bwb2lmaG9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1NzQ5MDAsImV4cCI6MjA4NzE1MDkwMH0.Ml1V2zc8j3XCZIuILuapy2Cs4jcBl0i6sHKxFFl6Sqo';
const ADMIN_PW='admin@123';
let allBookings=[],sortField='created_at',sortDir='desc',confirmCb=null;

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
window.addEventListener('load',()=>{
  setTimeout(()=>{
    document.getElementById('ls').classList.add('out');
    const loggedIn=sessionStorage.getItem('rtd_admin');
    document.getElementById('loginScreen').style.display='flex';
    if(loggedIn==='1') unlock();
  },1000);
});

// ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ
function doLogin(){
  const pw=document.getElementById('pwInput').value;
  const inp=document.getElementById('pwInput');
  if(pw===ADMIN_PW){sessionStorage.setItem('rtd_admin','1');unlock();}
  else{inp.classList.add('error');document.getElementById('loginErr').classList.add('show');setTimeout(()=>inp.classList.remove('error'),500);}
}
function togglePw(){
  const inp=document.getElementById('pwInput');
  inp.type=inp.type==='password'?'text':'password';
  document.getElementById('eyeBtn').textContent=inp.type==='password'?'üëÅ':'üôà';
}
function unlock(){
  document.getElementById('loginScreen').style.display='none';
  document.getElementById('app').style.display='block';
  document.getElementById('app').classList.add('vis');
  loadAll();loadSettings();
}
function confirmLogout(){
  openConfirm('Logout','Exit the admin panel?',()=>{sessionStorage.removeItem('rtd_admin');location.reload();},'gold');
}

// ‚îÄ‚îÄ API ‚îÄ‚îÄ
async function sbGet(ep){
  const res=await fetch(`${SB_URL}/rest/v1/${ep}`,{headers:{'apikey':SB_KEY,'Authorization':`Bearer ${SB_KEY}`}});
  if(!res.ok)throw new Error('HTTP '+res.status);
  return res.json();
}
async function sbPatch(table,filter,body){
  const res=await fetch(`${SB_URL}/rest/v1/${table}?${filter}`,{method:'PATCH',headers:{'apikey':SB_KEY,'Authorization':`Bearer ${SB_KEY}`,'Content-Type':'application/json','Prefer':'return=representation'},body:JSON.stringify(body)});
  if(!res.ok){const e=await res.json().catch(()=>({}));throw new Error(e.message||'HTTP '+res.status);}
  return res.json();
}
async function sbPost(table,body){
  const res=await fetch(`${SB_URL}/rest/v1/${table}`,{method:'POST',headers:{'apikey':SB_KEY,'Authorization':`Bearer ${SB_KEY}`,'Content-Type':'application/json','Prefer':'return=representation'},body:JSON.stringify(body)});
  if(!res.ok){const e=await res.json().catch(()=>({}));throw new Error(e.message||'HTTP '+res.status);}
  return res.json();
}
async function sbDelete(table,filter){
  const res=await fetch(`${SB_URL}/rest/v1/${table}?${filter}`,{method:'DELETE',headers:{'apikey':SB_KEY,'Authorization':`Bearer ${SB_KEY}`}});
  if(!res.ok)throw new Error('HTTP '+res.status);
}

function setSyncPill(state,msg){
  const p=document.getElementById('syncPill'),t=document.getElementById('syncTxt');
  p.className='sync-pill '+(state==='ok'?'ok':state==='err'?'err':'');
  t.textContent=msg;
}

// ‚îÄ‚îÄ LOAD ALL ‚îÄ‚îÄ
async function loadAll(){
  setSyncPill('','Syncing...');
  try{
    allBookings=await sbGet('bookings?select=*&order=created_at.desc');
    updateStats();filterTable();renderUsers();
    setSyncPill('ok','Live ‚úì ‚Äî '+allBookings.length+' bookings');
  }catch(e){
    setSyncPill('err','Error: '+e.message);
    showToast('Failed to load: '+e.message,'error');
  }
}

// ‚îÄ‚îÄ STATS ‚îÄ‚îÄ
function updateStats(){
  const total=allBookings.length;
  const approved=allBookings.filter(b=>b.status==='approved').length;
  const pending=allBookings.filter(b=>b.status==='pending').length;
  const rejected=allBookings.filter(b=>b.status==='rejected').length;
  const tickets=allBookings.reduce((s,b)=>s+(b.ticket_qty||0),0);
  const revenue=allBookings.filter(b=>b.status==='approved').reduce((s,b)=>s+(b.amount||0),0);
  const ids=['stTotal','stApproved','stPending','stRejected','stTickets','stRevenue'];
  const vals=[total,approved,pending,rejected,tickets,'‚Çπ'+revenue];
  ids.forEach((id,i)=>{
    const el=document.getElementById(id);
    if(!el)return;
    const nv=String(vals[i]);
    if(el.textContent!==nv){el.textContent=nv;el.classList.remove('pop');void el.offsetWidth;el.classList.add('pop');}
  });
  document.getElementById('revPill').textContent='‚Çπ'+revenue;
  const rate=total>0?Math.round(approved/total*100):0;
  document.getElementById('ratePill').textContent=rate+'%';
  document.getElementById('progLbl').textContent=approved+' / '+total;
  document.getElementById('progFill').style.width=rate+'%';
}

// ‚îÄ‚îÄ FILTER + RENDER TABLE ‚îÄ‚îÄ
function filterTable(){
  const q=document.getElementById('srchInput').value.toLowerCase();
  const sf=document.getElementById('statusFilter').value;
  const sortSel=document.getElementById('sortSel').value;
  let rows=[...allBookings];
  if(q)rows=rows.filter(b=>[b.booking_id,b.name,b.email,b.phone,b.utr].some(v=>v&&String(v).toLowerCase().includes(q)));
  if(sf)rows=rows.filter(b=>b.status===sf);
  if(sortSel==='oldest')rows.sort((a,b)=>new Date(a.created_at)-new Date(b.created_at));
  else if(sortSel==='amount_high')rows.sort((a,b)=>(b.amount||0)-(a.amount||0));
  else if(sortSel==='name_az')rows.sort((a,b)=>(a.name||'').localeCompare(b.name||''));
  else rows.sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));
  document.getElementById('resultCount').textContent='Showing '+rows.length+' of '+allBookings.length+' bookings';
  const tbody=document.getElementById('tbl');
  const noData=document.getElementById('noDataMsg');
  if(!rows.length){tbody.innerHTML='';noData.style.display='block';return;}
  noData.style.display='none';
  tbody.innerHTML=rows.map((b,i)=>`
    <tr class="row-in" style="animation-delay:${i*.025}s">
      <td><span class="bid">${b.booking_id||'‚Äî'}</span></td>
      <td><div class="name-cell"><strong>${esc(b.name||'‚Äî')}</strong><span>${esc(b.email||'')} ¬∑ ${esc(b.phone||'')}</span></div></td>
      <td style="font-family:'Space Mono',monospace;font-size:.8rem;text-align:center">${b.ticket_qty||1}</td>
      <td style="font-family:'Bebas Neue',sans-serif;font-size:1.1rem;color:var(--gold)">‚Çπ${b.amount||0}</td>
      <td style="font-family:'Space Mono',monospace;font-size:.65rem;color:var(--muted);max-width:110px;overflow:hidden;text-overflow:ellipsis">${esc(b.utr||'‚Äî')}</td>
      <td><div class="ocr-pair">
        <span style="color:${b.ocr_amount_match?'var(--green)':'var(--red)'}">${b.ocr_amount_match?'‚úì':'‚úó'} Amt</span><br>
        <span style="color:${b.ocr_upi_match?'var(--green)':'var(--red)'}">${b.ocr_upi_match?'‚úì':'‚úó'} UPI</span>
      </div></td>
      <td>${b.screenshot_url?`<img class="ss-thumb" src="${b.screenshot_url}" onclick="openImg('${b.screenshot_url}')" alt="SS">`:'<span style="color:var(--muted);font-size:.6rem">none</span>'}</td>
      <td><span class="sbadge ${b.status||'pending'}">${b.status||'pending'}</span></td>
      <td style="font-family:'Space Mono',monospace;font-size:.6rem;color:var(--muted);white-space:nowrap">${fmtDate(b.created_at)}</td>
      <td><div class="act-btns">
        ${b.status!=='approved'?`<button class="act-btn ap-btn" onclick="updateStatus('${b.id}','approved')">‚úì OK</button>`:''}
        ${b.status!=='rejected'?`<button class="act-btn rj-btn" onclick="updateStatus('${b.id}','rejected')">‚úó Rej</button>`:''}
        <button class="act-btn del-btn" onclick="confirmDeleteOne('${b.id}','${esc(b.booking_id||'')}')">üóë</button>
      </div></td>
    </tr>`).join('');
}

function esc(s){return String(s).replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function fmtDate(d){if(!d)return'‚Äî';const dt=new Date(d);return dt.toLocaleDateString('en-IN',{day:'2-digit',month:'short'})+'<br><span style="font-size:.56rem">'+dt.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'})+'</span>';}

function sortBy(field){
  if(sortField===field)sortDir=sortDir==='asc'?'desc':'asc';
  else{sortField=field;sortDir='asc';}
  allBookings.sort((a,b)=>{
    const va=a[field]||'',vb=b[field]||'';
    const cmp=typeof va==='number'?va-vb:String(va).localeCompare(String(vb));
    return sortDir==='asc'?cmp:-cmp;
  });
  filterTable();
}

// ‚îÄ‚îÄ UPDATE STATUS ‚îÄ‚îÄ
async function updateStatus(id,status){
  try{
    await sbPatch('bookings','id=eq.'+id,{status});
    const b=allBookings.find(x=>x.id==id);
    if(b)b.status=status;
    updateStats();filterTable();renderUsers();
    showToast(`Booking ${status==='approved'?'‚úÖ approved':'‚ùå rejected'}`,status==='approved'?'success':'warn');
    setTimeout(()=>loadAll(),800);
  }catch(e){showToast('Error: '+e.message,'error');}
}

// ‚îÄ‚îÄ APPROVE ALL PENDING ‚îÄ‚îÄ
async function approveAllPending(){
  const pending=allBookings.filter(b=>b.status==='pending');
  if(!pending.length){showToast('No pending bookings','info');return;}
  openConfirm('Approve All Pending',`Approve all ${pending.length} pending bookings?`,async()=>{
    try{
      let done=0;
      for(const b of pending){await sbPatch('bookings','id=eq.'+b.id,{status:'approved'});done++;}
      showToast(`‚úÖ ${done} bookings approved`,'success');
      setTimeout(loadAll,600);
    }catch(e){showToast('Error: '+e.message,'error');}
  },'gold');
}

// ‚îÄ‚îÄ DELETE ‚îÄ‚îÄ
function confirmDeleteOne(id,bid){
  openConfirm('Delete Booking',`Delete booking "${bid}"? This cannot be undone.`,async()=>{
    try{
      await sbDelete('bookings','id=eq.'+id);
      showToast('Booking deleted','info');
      setTimeout(loadAll,500);
    }catch(e){showToast('Error: '+e.message,'error');}
  });
}
function confirmDeleteAll(){
  openConfirm('DELETE ALL BOOKINGS','This will permanently delete ALL booking records. This cannot be undone.',async()=>{
    try{
      await sbDelete('bookings','id=neq.0');
      allBookings=[];updateStats();filterTable();renderUsers();
      showToast('All bookings deleted','warn');
    }catch(e){showToast('Error: '+e.message,'error');}
  });
}

// ‚îÄ‚îÄ USERS ‚îÄ‚îÄ
function renderUsers(){
  const q=(document.getElementById('userSearch')?.value||'').toLowerCase();
  const sort=(document.getElementById('userSort')?.value)||'recent';
  const userMap={};
  allBookings.forEach(b=>{
    const key=b.email||b.phone||b.name;if(!key)return;
    if(!userMap[key])userMap[key]={name:b.name,email:b.email,phone:b.phone,bookings:[],totalTickets:0,totalSpend:0,lastDate:null};
    userMap[key].bookings.push(b);
    userMap[key].totalTickets+=(b.ticket_qty||0);
    if(b.status==='approved')userMap[key].totalSpend+=(b.amount||0);
    const d=new Date(b.created_at);
    if(!userMap[key].lastDate||d>userMap[key].lastDate)userMap[key].lastDate=d;
  });
  let users=Object.values(userMap);
  if(q)users=users.filter(u=>[u.name,u.email,u.phone].some(v=>v&&v.toLowerCase().includes(q)));
  if(sort==='most_tickets')users.sort((a,b)=>b.totalTickets-a.totalTickets);
  else if(sort==='highest_spend')users.sort((a,b)=>b.totalSpend-a.totalSpend);
  else if(sort==='name_az')users.sort((a,b)=>(a.name||'').localeCompare(b.name||''));
  else users.sort((a,b)=>b.lastDate-a.lastDate);
  document.getElementById('userCount').textContent=users.length+' unique users';
  const grid=document.getElementById('usersGrid');
  if(!users.length){grid.innerHTML='<p style="color:var(--muted);font-family:Space Mono,monospace;font-size:.72rem;padding:30px;text-align:center">No users found</p>';return;}
  grid.innerHTML=users.map((u,i)=>`
    <div class="user-card" style="animation:rowIn .3s ease ${i*.04}s both">
      <div class="user-avatar">${(u.name||'?')[0].toUpperCase()}</div>
      <div class="user-info">
        <strong>${esc(u.name||'‚Äî')}</strong>
        <span>${esc(u.email||'')}${u.phone?' ¬∑ '+u.phone:''}</span>
        <span style="color:var(--muted);margin-top:1px">${u.bookings.length} booking(s) ¬∑ Last: ${u.lastDate?u.lastDate.toLocaleDateString('en-IN'):'‚Äî'}</span>
      </div>
      <div class="user-stats">
        <strong>${u.totalTickets}</strong>
        <span>tickets</span>
        <strong style="color:var(--green);font-size:.9rem">‚Çπ${u.totalSpend}</strong>
        <span>spent</span>
      </div>
    </div>`).join('');
}

// ‚îÄ‚îÄ SETTINGS LOAD ‚îÄ‚îÄ
async function loadSettings(){
  try{
    const data=await sbGet('app_settings?id=eq.1&select=*');
    if(data&&data.length>0){
      const s=data[0];
      setValue('stgMovieName',s.movie_name||'');
      setValue('stgPosterUrl',s.movie_poster_url||'');
      setValue('stgEventDate',s.event_date||'');
      setValue('stgEventDateDisplay',s.event_date_display||'');
      setValue('stgVenue',s.venue||'');
      setValue('stgDescription',s.event_description||'');
      setValue('stgPrice',s.ticket_price||'');
      setValue('stgMaxTix',s.max_tickets||'');
      setValue('stgUpi',s.upi_id||'');
      setValue('stgPayee',s.payee_name||'');
      const aa=document.getElementById('stgAutoApprove');if(aa)aa.checked=Boolean(s.auto_approve);
    }
  }catch(e){console.warn('Settings load failed:',e);}
}

function setValue(id,val){const el=document.getElementById(id);if(el)el.value=val;}

function previewMovieName(){
  const v=document.getElementById('stgMovieName').value;
  const lbl=document.getElementById('moviePrevLbl');
  if(lbl)lbl.textContent=v?v.toUpperCase().slice(0,12):'PREVIEW';
}

async function saveMovieName(){
  const name=document.getElementById('stgMovieName').value.trim();
  const poster=document.getElementById('stgPosterUrl').value.trim();
  if(!name){showStgMsg('movieMsg','Movie name cannot be empty','err');return;}
  const btn=document.querySelector('.movie-changer .btn-save');
  btn.disabled=true;btn.innerHTML='<span class="spn"></span>Saving...';
  try{
    await upsertSettings({movie_name:name,movie_poster_url:poster});
    showStgMsg('movieMsg','‚úÖ Movie name updated successfully!','ok');
    showToast('Movie name saved: '+name,'success');
  }catch(e){showStgMsg('movieMsg','Error: '+e.message,'err');}
  finally{btn.disabled=false;btn.innerHTML='üé¨ Save Movie Name & Poster';}
}

async function saveSettings(section){
  const map={
    event:{stgEventDate:'event_date',stgEventDateDisplay:'event_date_display',stgVenue:'venue',stgDescription:'event_description'},
    pricing:{stgPrice:'ticket_price',stgMaxTix:'max_tickets'},
    upi:{stgUpi:'upi_id',stgPayee:'payee_name'},
    automation:{stgAutoApprove:'auto_approve',stgRequireSS:'require_screenshot'}
  };
  const msgId={event:'eventMsg',pricing:'pricingMsg',upi:'upiMsg',automation:'autoMsg'}[section];
  const fields=map[section];
  const body={};
  for(const [inputId,col] of Object.entries(fields)){
    const el=document.getElementById(inputId);if(!el)continue;
    body[col]=el.type==='checkbox'?el.checked:(el.value.trim()||null);
    if(col==='ticket_price'||col==='max_tickets')body[col]=Number(el.value)||null;
  }
  try{
    await upsertSettings(body);
    showStgMsg(msgId,'‚úÖ Settings saved!','ok');
    showToast('Settings saved','success');
  }catch(e){showStgMsg(msgId,'Error: '+e.message,'err');}
}

async function upsertSettings(body){
  const res=await fetch(`${SB_URL}/rest/v1/app_settings?id=eq.1`,{method:'PATCH',headers:{'apikey':SB_KEY,'Authorization':`Bearer ${SB_KEY}`,'Content-Type':'application/json','Prefer':'return=minimal'},body:JSON.stringify(body)});
  if(!res.ok){
    // If no row exists, insert
    const res2=await fetch(`${SB_URL}/rest/v1/app_settings`,{method:'POST',headers:{'apikey':SB_KEY,'Authorization':`Bearer ${SB_KEY}`,'Content-Type':'application/json','Prefer':'return=minimal'},body:JSON.stringify({id:1,...body})});
    if(!res2.ok)throw new Error('Save failed HTTP '+res2.status);
  }
}

function showStgMsg(id,msg,type){
  const el=document.getElementById(id);if(!el)return;
  el.textContent=msg;el.className='stg-msg '+type;
  setTimeout(()=>{el.className='stg-msg';},4500);
}

// ‚îÄ‚îÄ EXPORT CSV ‚îÄ‚îÄ
function exportCSV(){
  if(!allBookings.length){showToast('No data to export','info');return;}
  const headers=['Booking ID','Name','Email','Phone','Tickets','Amount','UTR','Status','OCR Amount','OCR UPI','Movie','Created At'];
  const rows=allBookings.map(b=>[b.booking_id,b.name,b.email,b.phone,b.ticket_qty,b.amount,b.utr,b.status,b.ocr_amount_match?'Yes':'No',b.ocr_upi_match?'Yes':'No',b.movie_name,b.created_at].map(v=>`"${String(v||'').replace(/"/g,'""')}"`).join(','));
  const csv=[headers.join(','),...rows].join('\n');
  const a=document.createElement('a');
  a.href='data:text/csv;charset=utf-8,\uFEFF'+encodeURIComponent(csv);
  a.download='rtd-bookings-'+new Date().toISOString().slice(0,10)+'.csv';
  a.click();showToast('CSV exported ('+allBookings.length+' rows)','success');
}

// ‚îÄ‚îÄ TAB SWITCH ‚îÄ‚îÄ
function switchTab(name,btn){
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  btn.classList.add('active');
}

// ‚îÄ‚îÄ IMAGE MODAL ‚îÄ‚îÄ
function openImg(url){document.getElementById('modalImg').src=url;document.getElementById('imgModal').classList.add('show');}
function closeImgModal(){document.getElementById('imgModal').classList.remove('show');}

// ‚îÄ‚îÄ CONFIRM MODAL ‚îÄ‚îÄ
function openConfirm(title,msg,cb,btnStyle){
  document.getElementById('confirmTitle').textContent=title;
  document.getElementById('confirmMsg').textContent=msg;
  const yes=document.getElementById('confirmYes');
  yes.className='cbtn cbtn-yes'+(btnStyle==='gold'?' gold':'');
  confirmCb=cb;
  document.getElementById('confirmModal').classList.add('show');
}
function confirmExec(){closeConfirm();if(confirmCb)confirmCb();}
function closeConfirm(){document.getElementById('confirmModal').classList.remove('show');confirmCb=null;}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
function showToast(msg,type=''){
  const t=document.getElementById('toast');
  t.textContent=msg;t.className=`toast ${type} show`;
  setTimeout(()=>t.className=`toast ${type}`,4000);
}
</script>
</body>
</html>
